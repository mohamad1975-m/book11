<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مدیریت کامنت‌ها</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'IranYekanX';
      src: url('/fonts/iranyekanx.woff2') format('woff2');
    }
    body {
      font-family: 'IranYekanX', sans-serif;
      direction: rtl;
      background: linear-gradient(to right, #f8fafc, #f1f5f9);
    }
  </style>
</head>
<body class="p-6">

  <h1 class="text-2xl font-bold mb-6">🛠 مدیریت کامنت‌ها</h1>

  <div id="commentsList" class="space-y-4"></div>

  <template id="comment-template">
    <div class="p-4 bg-white rounded-2xl shadow-md flex justify-between items-center">
      <div class="flex-1">
        <p class="text-gray-900 font-medium mb-1 comment-text"></p>
        <p class="text-sm text-gray-500">نام مستعار: <span class="comment-name"></span></p>
      </div>
      <div class="flex gap-2">
        <button class="edit-btn px-3 py-1 rounded-lg bg-yellow-400 hover:bg-yellow-500 text-white text-sm">ویرایش</button>
        <button class="delete-btn px-3 py-1 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm">حذف</button>
      </div>
    </div>
  </template>

  <script>
    async function fetchComments() {
      const container = document.getElementById("commentsList");
      container.innerHTML = "<p>در حال بارگذاری...</p>";

      try {
        const res = await fetch(`/api/book-comments?slug=geography`);
        const data = await res.json();

        container.innerHTML = "";
        if (!data.list || data.list.length === 0) {
          container.innerHTML = "<p>هیچ کامنتی وجود ندارد.</p>";
          return;
        }

        data.list.forEach(c => {
          const tmpl = document.getElementById("comment-template").content.cloneNode(true);
          tmpl.querySelector(".comment-text").textContent = c.text;
          tmpl.querySelector(".comment-name").textContent = c.name || "بدون نام";

          // حذف
          tmpl.querySelector(".delete-btn").addEventListener("click", async () => {
            if (confirm("آیا مطمئن هستید که می‌خواهید این کامنت را حذف کنید؟")) {
              await fetch(`/api/admin-delete?slug=geography&id=${c.id}`, { method: "DELETE" });
              fetchComments();
            }
          });

          // ویرایش
          tmpl.querySelector(".edit-btn").addEventListener("click", async () => {
            const newText = prompt("متن جدید کامنت:", c.text);
            if (newText && newText.trim()) {
              await fetch(`/api/admin-edit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ slug: "geography", id: c.id, text: newText.trim(), name: c.name })
              });
              fetchComments();
            }
          });

          container.appendChild(tmpl);
        });
      } catch (err) {
        container.innerHTML = "<p class='text-red-500'>خطا در دریافت کامنت‌ها</p>";
      }
    }

    fetchComments();
  </script>
</body>
</html>
