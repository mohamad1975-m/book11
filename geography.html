<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>جغرافیا</title>
<style>
  @font-face{
    font-family:'iranyekanX';
    src:url('IRANYekanX-Light.woff2') format('woff2');
  }
  *{box-sizing:border-box}
  body{
    font-family:'iranyekanX',sans-serif;margin:0;padding:0;color:#fff;
    background:radial-gradient(circle at 20% 20%,#e3f2fd,transparent 40%),
               radial-gradient(circle at 80% 25%,#d4fc79,transparent 42%),
               radial-gradient(circle at 20% 80%,#ffd3a5,transparent 42%),
               linear-gradient(180deg,#58a 0%,#2c3e50 100%);
    background-attachment:fixed;min-height:100vh;position:relative;
  }
  body::before{content:"";position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.25));pointer-events:none;z-index:0}
  header{
    text-align:center;font-weight:800;margin:26px 0 10px;font-size:38px;
    background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#fbbf24,#f87171);
    background-size:400% 400%;
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    animation:headGrad 18s ease infinite;text-shadow:0 0 10px rgba(255,255,255,.25);position:relative;z-index:1
  }
  @keyframes headGrad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  /* toolbar */
  .toolbar{width:100%;max-width:1100px;margin:0 auto 12px;display:flex;gap:10px;align-items:center;justify-content:center;position:relative;z-index:1}
  .search{flex:1;max-width:380px;display:flex;gap:8px}
  .search input{flex:1;border:none;border-radius:12px;padding:12px 14px;background:rgba(255,255,255,.14);color:#fff;outline:none;box-shadow:0 6px 16px rgba(0,0,0,.3)}
  .sort-btn,.btn{border:none;background:rgba(255,255,255,.14);color:#fff;padding:12px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.3)}
  .sort-btn:hover,.btn:hover{background:rgba(255,255,255,.20)}
  .modal-sort{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10;opacity:0;transition:opacity .16s ease}
  .modal-sort.show{opacity:1}
  .modal-sort .box{width:92%;max-width:520px;background:rgba(30,41,59,.8);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:14px;box-shadow:0 14px 32px rgba(0,0,0,.5)}
  .sort-title{font-weight:700;margin-bottom:8px}
  .row{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

  /* books */
  .wrap{width:100%;max-width:1100px;margin:0 auto;position:relative;z-index:1}
  .books{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;padding:12px}
  .books li{list-style:none}
  .book-card{
    display:grid;grid-template-columns:1fr auto;gap:12px;padding:12px;border-radius:16px;
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);
    box-shadow:0 10px 25px rgba(0,0,0,.35);backdrop-filter: blur(6px);
    transition: transform .18s ease, background .18s ease;position:relative
  }
  .book-card:hover{transform:translateY(-3px);background:rgba(255,255,255,.16);box-shadow:0 12px 28px rgba(0,0,0,.45)}
  .title{font-size:16.5px;line-height:1.6;white-space:normal;word-break:break-word;text-shadow:0 2px 6px rgba(0,0,0,.45);direction:rtl}
  .dcount{font-size:13px;opacity:.9}

  /* آیکون‌های چپ – گرید ۲×۶ (سه سطر آیکون + سه سطر برچسب) */
  .left-acts{
    display:grid;
    grid-template-columns:46px 46px;
    grid-template-rows:38px 14px 38px 14px 38px 14px; /* icon,label,icon,label,icon,label */
    gap:6px 10px; align-items:center; justify-items:center; min-width: 134px;
  }
  .left-acts .icon-wrap{
    width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;
    border-radius:10px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);
    box-shadow:0 6px 16px rgba(0,0,0,.3);transition:transform .14s ease, background .14s ease
  }
  .left-acts .icon-wrap:hover{background:rgba(255,255,255,.2);transform:translateY(-2px)}
  .left-acts svg{width:22px;height:22px;fill:#fff}
  .under-txt{font-size:12px;opacity:.9}

  /* preview modal */
  .pv{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20;opacity:0;transition:opacity .16s ease}
  .pv.show{opacity:1}
  .pv .box{width:92%;max-width:640px;background:rgba(30,41,59,.8);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:14px;box-shadow:0 16px 34px rgba(0,0,0,.55)}
  .pv .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .pv .close{border:none;background:rgba(255,255,255,.14);color:#fff;width:32px;height:32px;border-radius:10px;cursor:pointer}
  .pv .body{font-size:14.5px;line-height:1.8}

  /* --- افزوده‌ها: علاقه‌مندی + چیپ برچسب + جایگاه لیبل‌های شمارنده --- */
  .left-acts .fav{ grid-column:1; grid-row:5; }
  .left-acts .fav-label{ grid-column:1; grid-row:6; }
  .icon-wrap.fav.active{ background: rgba(255,255,255,.2); box-shadow: 0 8px 20px rgba(0,0,0,.45); }
  .icon-wrap.fav .heart-filled{ display:none }
  .icon-wrap.fav.active .heart-filled{ display:block }
  .icon-wrap.fav.active .heart-outline{ display:none }
  .tag-chip{ display:inline-block; margin:3px; padding:4px 8px; border-radius:999px;
    background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); font-size:12px }
  .left-acts .share-label{ grid-column:1; grid-row:4; }
  .left-acts [data-buycount]{ grid-column:2; grid-row:4; }
</style>
</head>
<body>

<header>جغرافیا</header>

<div class="toolbar">
  <div class="search">
    <input id="q" placeholder="جستجو..." />
    <button class="btn" id="btnSearch">جستجو</button>
  </div>
  <button class="sort-btn" id="sortBtn">مرتب‌سازی</button>
  <!-- دکمه «برچسب» با اسکریپت تزریق می‌شود -->
</div>

<div class="wrap">
  <ul class="books">
    <!-- ====== کارت‌ها (نمونه‌ها) ====== -->
    <li data-id="geo11-test">
      <div class="book-card" data-href="https://mega.nz/file/EygHRLaZ#XYM70813eKudH6DVdHsdduHbCb9I5d-W6NqhVDMngfs">
        <div class="left-acts">
          <!-- ردیف 1 -->
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587l3.668 7.4L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
          </div>
          <!-- ردیف 2 (برچسب‌ها) -->
          <div class="under-txt size-label" data-size>88 MB</div>
          <div class="under-txt rate-label" data-rate>؟</div>
          <!-- ردیف 3 -->
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.3 3.3 0 000-1.39l7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34-3 3c0 .23.03.45.08.66L7.91 9.77a2.99 2.99 0 100 4.46l7.17 4.13c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5L4 6H0v2h2l3 9-1 3a2 2 0 002 2h12v-2H6.42a.5.5 0 01-.48-.36L6 17h11a2 2 0 001.96-1.64L21 7H7V4zm0 4h11.1l-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <div class="under-txt share-label"></div>
          <!-- ردیف 5 / 6 -->
          <div class="icon-wrap comment" title="کامنت‌ها">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt cmt-label" data-cmtcount>۰</div>
        </div>
        <span class="title">پرسش‌های چهارگزینه‌ای (به همراه درسنامه) – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
      </div>
    </li>

    <li data-id="geo11-shab">
      <div class="book-card" data-href="https://mega.nz/file/ItJ0jarZ#x0lgFCaU88qK3pfdIJD7G7d6yWv1ao1YWHd5RkFfHqU">
        <div class="left-acts">
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587l3.668 7.4L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
          </div>
          <div class="under-txt size-label" data-size>23 MB</div>
          <div class="under-txt rate-label" data-rate>؟</div>
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.3 3.3 0 000-1.39l7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34-3 3c0 .23.03.45.08.66L7.91 9.77a2.99 2.99 0 100 4.46l7.17 4.13c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5L4 6H0v2h2l3 9-1 3a2 2 0 002 2h12v-2H6.42a.5.5 0 01-.48-.36L6 17h11a2 2 0 001.96-1.64L21 7H7V4zm0 4h11.1l-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <div class="under-txt share-label"></div>
          <div class="icon-wrap comment" title="کامنت‌ها">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt cmt-label" data-cmtcount>۰</div>
        </div>
        <span class="title">شب امتحان – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
      </div>
    </li>

    <li data-id="geo10-shab">
      <div class="book-card" data-href="https://mega.nz/file/NiBiXKxD#I6f-3pWZUP2vS-1mS6mQy2g6YbH4V3oI8oA02pZb7nQ">
        <div class="left-acts">
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587l3.668 7.4L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
          </div>
          <div class="under-txt size-label" data-size>24 MB</div>
          <div class="under-txt rate-label" data-rate>؟</div>
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.3 3.3 0 000-1.39l7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34-3 3c0 .23.03.45.08.66L7.91 9.77a2.99 2.99 0 100 4.46l7.17 4.13c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5L4 6H0v2h2l3 9-1 3a2 2 0 002 2h12v-2H6.42a.5.5 0 01-.48-.36L6 17h11a2 2 0 001.96-1.64L21 7H7V4zm0 4h11.1l-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <div class="under-txt share-label"></div>
          <div class="icon-wrap comment" title="کامنت‌ها">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt cmt-label" data-cmtcount>۰</div>
        </div>
        <span class="title">شب امتحان – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
      </div>
    </li>

    <li data-id="geo10-dars">
      <div class="book-card" data-href="https://mega.nz/file/mrAmGJSb#eFZ2jQe7PydFhJ3k2yM5m6xw5vZNE1QbqcnkAA3j7pI">
        <div class="left-acts">
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587l3.668 7.4L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
          </div>
          <div class="under-txt size-label" data-size>36 MB</div>
          <div class="under-txt rate-label" data-rate>؟</div>
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.3 3.3 0 000-1.39l7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34-3 3c0 .23.03.45.08.66L7.91 9.77a2.99 2.99 0 100 4.46l7.17 4.13c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5L4 6H0v2h2l3 9-1 3a2 2 0 002 2h12v-2H6.42a.5.5 0 01-.48-.36L6 17h11a2 2 0 001.96-1.64L21 7H7V4zm0 4h11.1 ل-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <div class="under-txt share-label"></div>
          <div class="icon-wrap comment" title="کامنت‌ها">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt cmt-label" data-cmtcount>۰</div>
        </div>
        <span class="title">درسنامه – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
      </div>
    </li>
    <!-- ====== /کارت‌ها ====== -->
  </ul>
</div>

<!-- مودال پیش‌نمایش -->
<div class="pv" id="previewModal">
  <div class="box">
    <div class="head">
      <div id="pvTitle">پیش‌نمایش</div>
      <button class="close" id="pvClose">×</button>
    </div>
    <div class="body" id="pvBody"></div>
  </div>
</div>

<!-- مودال مرتب‌سازی -->
<div class="modal-sort" id="sortModal">
  <div class="box">
    <div class="sort-title">مرتب‌سازی</div>
    <ul id="sortList" style="list-style:none;padding:0;margin:0">
      <li data-sort="default" class="active" style="padding:8px 6px;cursor:pointer;border-radius:8px">پیش‌فرض</li>
      <li data-sort="rate" style="padding:8px 6px;cursor:pointer;border-radius:8px">امتیاز بالاتر</li>
      <li data-sort="size" style="padding:8px 6px;cursor:pointer;border-radius:8px">حجم کمتر</li>
      <li data-sort="downloads" style="padding:8px 6px;cursor:pointer;border-radius:8px">دانلود بیشتر</li>
    </ul>
    <div class="row">
      <button class="btn" id="btnSortClose">بستن</button>
    </div>
  </div>
</div>

<script>
/* ====================== دیتا و ابزارهای اصلی ====================== */

const bookMeta={
    'geo11-test':{size:'88 MB',rate:null,votes:null,buy:'https://www.digikala.com/product/dkp-5746151/%DA%A9%D8%AA%D8%A7%D8%A8-%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7-2-%D9%BE%D8%A7%DB%8C%D9%87-%DB%8C%D8%A7%D8%B2%D8%AF%D9%87%D9%85-%D8%B1%D8%B4%D8%AA%D9%87-%D8%A7%D9%86%D8%B3%D8%A7%D9%86%DB%8C-%D8%A7%D8%AB%D8%B1-%D8%B2%D9%87%D8%B1%D8%A7-%D9%86%D8%B9%D9%85%D8%AA%DB%8C-%D9%88-%D8%A7%D9%84%D9%87%D9%87-%D9%87%D9%85%D8%A7%DB%8C%D9%88%D9%86-%D8%B2%D8%A7%D8%AF%D9%87-%D8%A7%D9%86%D8%AA%D8%B4%D8%A7%D8%B1%D8%A7%D8%AA-%D8%AE%DB%8C%D9%84%DB%8C-%D8%B3%D8%A8%D8%B2/', publisher:'خیلی سبز', tags:['تست','درسنامه','خیلی‌سبز']},
    'geo11-shab':{size:'23 MB',rate:4.4,votes:26,buy:'https://www.digikala.com/product/dkp-820916/%DA%A9%D8%AA%D8%A7%D8%A8-%D8%B4%D8%A8-%D8%A7%D9%85%D8%AA%D8%AD%D8%A7%D9%86-%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7-%D9%BE%D8%A7%DB%8C%D9%87-%DB%8C%D8%A7%D8%B2%D8%AF%D9%87%D9%85-%D8%A7%D8%AB%D8%B1-%D8%B3%DB%8C%D8%AF%D9%87-%D9%85%D8%B1%DB%8C%D9%85-%D8%B7%D8%A7%D9%87%D8%B1%DB%8C/', publisher:'خیلی سبز', tags:['شب‌امتحان','خیلی‌سبز']},
    'geo10-shab':{size:'24 MB',rate:4.5,votes:67,buy:'https://www.digikala.com/product/dkp-4123378/%DA%A9%D8%AA%D8%A7%D8%A8-%D8%B4%D8%A8-%D8%A7%D9%85%D8%AA%D8%AD%D8%A7%D9%86-%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7-%D8%A7%DB%8C%D8%B1%D8%A7%D9%86-%D8%AF%D9%87%D9%85-%D8%A7%D8%AB%D8%B1-%D9%85%D9%87%D8%AF%DB%8C-%DA%A9%D8%A7%D8%B1%D8%AF%D8%A7%D9%86-%D9%88-%D8%B4%D8%A7%D8%AF%DB%8C-%DA%A9%D8%A7%D8%B1%DB%8C%D8%A7%D9%86-%D8%A7%D9%86%D8%AA%D8%B4%D8%A7%D8%B1%D8%A7%D8%AA-%D8%AE%DB%8C%D9%84%DB%8C-%D8%B3%D8%A8%D8%B2/', publisher:'خیلی سبز', tags:['شب‌امتحان','خیلی‌سبز']},
    'geo10-dars':{size:'36 MB',rate:4.2,votes:45,buy:'https://www.digikala.com/product/dkp-16924367/%DA%A9%D8%AA%D8%A7%D8%A8-%D9%BE%D8%B1%D8%B3%D8%B4-%D9%87%D8%A7%DB%8C-%DA%86%D9%87%D8%A7%D8%B1%DA%AF%D8%B2%DB%8C%D9%86%D9%87-%D8%A7%DB%8C-%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7-%D8%AC%D8%A7%D9%85%D8%B9-%D8%A7%D8%AB%D8%B1-%D8%AF%DA%A9%D8%AA%D8%B1-%D8%B2%D9%87%D8%B1%D8%A7-%D9%86%D8%B9%D9%85%D8%AA%DB%8C-%D9%88-%D8%AF%DA%A9%D8%AA%D8%B1-%D8%AD%D9%85%DB%8C%D8%AF%D8%B1%D8%B6%D8%A7-%D8%A8%D9%87%DB%8C%D8%A7%D8%AF-%D8%A7%D9%86%D8%AA%D8%B4%D8%A7%D8%B1%D8%A7%D8%AA-%D8%AE%DB%8C%D9%84%DB%8C-%D8%B3%D8%A8%D8%B2/', publisher:'خیلی سبز', tags:['درسنامه','خیلی‌سبز']}
  };

  /* ---- ابزارهای محلی/عمومی ---- */
  function lsGet(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
  function lsSet(k,v){localStorage.setItem(k,JSON.stringify(v))}
  const devId=(localStorage.getItem('device_id') || (()=>{const v='dvc_'+Math.random().toString(36).slice(2);localStorage.setItem('device_id',v);return v})());

  /* ---- دانلودها (Upstash) ---- */
  async function getDownloads(book){
    try{
      const r=await fetch(`/api/downloads?book=${encodeURIComponent(book)}`,{cache:'no-store'});
      const d=await r.json(); return d?.value ?? 0;
    }catch{ return 0 }
  }
  async function addDownload(book){
    try{
      const r=await fetch(`/api/downloads`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({book})});
      const d=await r.json(); return d?.value ?? 0;
    }catch{ return 0 }
  }

  /* ---- کامنت‌ها (نمونه‌ی شمارش) ---- */
  async function getCmtCount(book){
    try{
      const r=await fetch(`/api/book-comments?book=${encodeURIComponent(book)}`,{cache:'no-store'});
      const d=await r.json(); return d?.count ?? 0;
    }catch{ return 0 }
  }

  /* ---- جستجو/مرتب‌سازی ---- */
  const q=document.getElementById('q');
  const btnSearch=document.getElementById('btnSearch');
  btnSearch.addEventListener('click',applySearch);
  q.addEventListener('keydown',e=>{if(e.key==='Enter')applySearch()});
  async function applySearch(){
    const term=q.value.trim();
    document.querySelectorAll('.books li').forEach(li=>{
      const title=li.querySelector('.title').textContent;
      li.style.display = term? (title.includes(term)? '' : 'none') : '';
    })
  }

  const sortBtn=document.getElementById('sortBtn');
  const sortModal=document.getElementById('sortModal');
  const sortList=document.getElementById('sortList');
  const sortClose=document.getElementById('btnSortClose');
  let currentSort='default';
  function openSort(){sortModal.style.display='flex';setTimeout(()=>sortModal.classList.add('show'),10)}
  function closeSort(){sortModal.classList.remove('show');setTimeout(()=>sortModal.style.display='none',160)}
  sortBtn.addEventListener('click',openSort);
  sortClose.addEventListener('click',closeSort);
  sortModal.addEventListener('click',e=>{if(e.target===sortModal)closeSort()});
  sortList.querySelectorAll('li').forEach(li=>{
    li.addEventListener('click',async()=>{
      sortList.querySelectorAll('li').forEach(x=>x.classList.remove('active'));
      li.classList.add('active'); currentSort=li.dataset.sort;
      await applySort(); sortBtn.textContent='مرتب‌سازی: '+li.textContent.trim(); closeSort();
    })
  })
  async function applySort(){
    const items=[...document.querySelectorAll('.books li')].filter(li=>li.style.display!=='none');
    const rank={
      default:()=>0,
      rate:li=>-(bookMeta[li.dataset.id]?.rate||0),
      size:li=>parseFloat((bookMeta[li.dataset.id]?.size||'0').split(' ')[0]||'0'),
      downloads:li=>-parseInt((li.querySelector('[data-dlc]')?.textContent||'0').replace(/[^\d]/g,''),10)
    }
    items.sort((a,b)=> rank[currentSort](a)-rank[currentSort](b));
    const parent=items[0]?.parentNode;
    if(parent) items.forEach(x=>parent.appendChild(x));
  }

  /* ---- اولیه‌سازی کارت‌ها ---- */
  function initCards(){
    document.querySelectorAll('.book-card').forEach(card=>{
      const li=card.closest('li'); const id=li.dataset.id;
      const countEl=card.querySelector('[data-dlc]');
      const starTip=card.querySelector('.star-tip');
      const meta=bookMeta[id]||{};
      const rateEl=card.querySelector('[data-rate]');
      const sizeEl=card.querySelector('[data-size]');
      const cmtCountEl=card.querySelector('[data-cmtcount]');
      const titleText=card.querySelector('.title').firstChild.textContent.trim();

      if(sizeEl) sizeEl.textContent=meta.size||'—';
      rateEl.textContent=(meta.rate==null?'؟':meta.rate);

      getDownloads(id).then(v=>{countEl.textContent=`(${v} دانلود)`});
      getCmtCount(id).then(v=>{cmtCountEl.textContent=(v||0).toLocaleString('fa-IR')});

      card.querySelector('.icon-wrap.dl').addEventListener('click',async e=>{
        e.stopPropagation();
        const nv=await addDownload(id); countEl.textContent=`(${nv} دانلود)`;
        const href=card.dataset.href; if(href) window.open(href,'_blank','noopener');
      });

      /* ===== اشتراک‌گذاری پیشرفته (بازنویسی) ===== */
      card.querySelector('.icon-wrap.share').addEventListener('click', async e=>{
        e.stopPropagation();
        const title = titleText;
        const href  = card.dataset.href;
        const meta  = bookMeta[id]||{};
        const pub   = meta.publisher ? `ناشر: ${meta.publisher}\n` : '';
        const rating= (meta.rate==null) ? '' : `امتیاز: ${meta.rate}${meta.votes?` از ${meta.votes} رأی`:''}\n`;
        const buy   = meta.buy ? `خرید: ${meta.buy}\n` : '';
        const dlnk  = href ? `دانلود PDF: ${href}\n` : '';
        const more  = `\nبرای مشاهده‌ی کتاب‌های بیشتر روی لینک زیر کلیک کنید:\nhttps://book11-one.vercel.app/`;
        const text  = `«${title}»\n${pub}${rating}${buy}${dlnk}${more}`;
        if(navigator.share){ try{ await navigator.share({title, text}); }catch{} }
        else{
          try{ await navigator.clipboard.writeText(text); alert('متن اشتراک‌گذاری کپی شد'); }
          catch{ alert('کپی نشد؛ دستی کپی کنید.') }
        }
      });

      card.querySelector('.icon-wrap.buy').addEventListener('click',e=>{
        e.stopPropagation(); if(meta.buy) window.open(meta.buy,'_blank','noopener');
      });

      card.addEventListener('click',e=>{
        if(e.target.closest('.left-acts')) return;
        openPreview(card,id);
      });
    });
  }

  /* ---- پیش‌نمایش ---- */
  const pv=document.getElementById('previewModal');
  const pvClose=document.getElementById('pvClose');
  pvClose.addEventListener('click',()=>{pv.classList.remove('show');setTimeout(()=>pv.style.display='none',160)});
  function openPreview(card,id){
    const href=card.dataset.href;
    const t=card.querySelector('.title').textContent.replace(/\(\d+ دانلود\)/,'').trim();
    document.getElementById('pvTitle').textContent='پیش‌نمایش «'+t+'»';
    document.getElementById('pvBody').innerHTML=
      `<div>لینک دانلود: ${href?`<a href="${href}" target="_blank" style="color:#aef">باز کردن</a>`:'نامشخص'}</div>`;
    pv.style.display='flex'; setTimeout(()=>pv.classList.add('show'),10);
  }
  window.openPreview=openPreview;

  /* شروع */
  initCards();
</script>

<!-- ===== افزونه‌ها: علاقه‌مندی + فیلتر برچسب + پیش‌نمایش غنی + شمارنده‌های share/buy ===== -->
<script>
(function(){
  // device id
  const deviceId = (localStorage.getItem('device_id') || (()=>{const v='dvc_'+Math.random().toString(36).slice(2);localStorage.setItem('device_id',v);return v})());

  // local favorites
  const FAVS_KEY='my_favs';
  function getMyFavs(){ try{return JSON.parse(localStorage.getItem(FAVS_KEY))||[]}catch{return []} }
  function setMyFavs(v){ localStorage.setItem(FAVS_KEY, JSON.stringify(v)) }
  function isMyFav(id){ return getMyFavs().includes(id) }
  function addMyFav(id){ const s=new Set(getMyFavs()); s.add(id); setMyFavs([...s]) }
  function removeMyFav(id){ const s=new Set(getMyFavs()); s.delete(id); setMyFavs([...s]) }

  // server favorites
  async function favGet(book){
    const r = await fetch(`/api/favorites?book=${encodeURIComponent(book)}&device=${encodeURIComponent(deviceId)}`, { cache:'no-store' });
    const d = await r.json(); return { count: d?.count ?? 0, isFav: !!d?.isFav };
  }
  async function favToggle(book, toAdd){
    const r = await fetch('/api/favorites', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ book, device: deviceId, op: toAdd?'add':'remove' }) });
    const d = await r.json();
    if(!r.ok) throw new Error(d?.error||'fav error');
    return { count: d?.count ?? 0, isFav: !!d?.isFav };
  }

  // Tags button + modal
  const toolbar = document.querySelector('.toolbar');
  if(toolbar && !document.getElementById('btnTags')){
    const btn = document.createElement('button');
    btn.id='btnTags'; btn.className='sort-btn'; btn.textContent='برچسب';
    toolbar.appendChild(btn);
  }
  if(!document.getElementById('tagsModal')){
    const modal = document.createElement('div');
    modal.className='modal-sort'; modal.id='tagsModal'; modal.innerHTML = `
      <div class="box">
        <div class="sort-title">فیلتر بر اساس برچسب‌ها</div>
        <div id="tagsContainer" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        <div class="row">
          <button class="btn gray" id="btnTagsClear">پاک کردن</button>
          <button class="btn" id="btnTagsApply">اعمال</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
  const btnTags = document.getElementById('btnTags');
  const tagsModal = document.getElementById('tagsModal');
  const tagsContainer = document.getElementById('tagsContainer');
  const btnTagsClear = document.getElementById('btnTagsClear');
  const btnTagsApply = document.getElementById('btnTagsApply');
  let selectedTags = new Set();

  function openTags(){ buildTagsList(); tagsModal.style.display='flex'; setTimeout(()=>tagsModal.classList.add('show'),10) }
  function closeTags(){ tagsModal.classList.remove('show'); setTimeout(()=>tagsModal.style.display='none',160) }
  btnTags && btnTags.addEventListener('click', openTags);
  tagsModal && tagsModal.addEventListener('click', e=>{ if(e.target===tagsModal) closeTags() });

  function buildTagsList(){
    const all = new Set();
    Object.values(bookMeta).forEach(m => (m.tags||[]).forEach(t=>all.add(t)));
    const list = [...all].sort((a,b)=> a.localeCompare(b,'fa'));
    tagsContainer.innerHTML = list.map(t=>`
      <label style="display:inline-flex;align-items:center;gap:6px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; cursor:pointer">
        <input type="checkbox" value="${t}" ${selectedTags.has(t)?'checked':''} />
        <span>${t}</span>
      </label>
    `).join('');
  }
  btnTagsClear && btnTagsClear.addEventListener('click', ()=>{ selectedTags.clear(); buildTagsList(); });
  btnTagsApply && btnTagsApply.addEventListener('click', ()=>{
    selectedTags = new Set([...tagsContainer.querySelectorAll('input[type=checkbox]:checked')].map(i=>i.value));
    applyTagFilter(); closeTags();
  });
  function applyTagFilter(){
    const active = [...selectedTags];
    document.querySelectorAll('.books li').forEach(li=>{
      const id=li.dataset.id, meta=bookMeta[id]||{};
      const tags = meta.tags || [];
      const ok = active.length===0 ? true : active.every(t=>tags.includes(t));
      li.style.display = ok ? '' : 'none';
    });
  }

  // Enhance cards: favorites + preview tags + counters
  function enhanceCards(){
    document.querySelectorAll('.book-card').forEach(card=>{
      const li=card.closest('li'); const id=li?.dataset?.id;
      if(!id) return;
      const left=card.querySelector('.left-acts');
      const meta=bookMeta[id]||{};

      // --- favorites ---
      if(left && !left.querySelector('.icon-wrap.fav')){
        const favBtn = document.createElement('div');
        favBtn.className='icon-wrap fav'; favBtn.title='علاقه‌مندی';
        favBtn.innerHTML = '<svg class="heart-outline" viewBox="0 0 24 24"><path d="M12.1 8.64l-.1.1-.11-.11C10.14 6.9 7.1 7 5.5 8.6c-1.67 1.67-1.67 4.38 0 6.05l6.3 6.3 6.3-6.3c1.67-1.67 1.67-4.38 0-6.05-1.6-1.6-4.64-1.7-6.3.04z" fill="none" stroke="white" stroke-width="1.6"/></svg><svg class="heart-filled" viewBox="0 0 24 24"><path d="M12.1 21.35l-1.1-1.01C5.14 15.28 2 12.36 2 8.99 2 6.42 4.42 4 7 4c1.54 0 3.04.73 4 1.87C11.96 4.73 13.46 4 15 4c2.58 0 5 2.42 5 4.99 0 3.37-3.14 6.29-8.9 11.35z"/></svg>';
        left.appendChild(favBtn);
        const favLbl = document.createElement('div');
        favLbl.className='under-txt fav-label'; favLbl.textContent='۰';
        left.appendChild(favLbl);
        favGet(id).then(({count,isFav})=>{
          favLbl.textContent = (count||0).toLocaleString('fa-IR');
          const myFav = isMyFav(id);
          if(isFav && !myFav) addMyFav(id);
          if(!isFav && myFav) removeMyFav(id);
          favBtn.classList.toggle('active', isMyFav(id));
        }).catch(()=>{});
        favBtn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          const willAdd = !favBtn.classList.contains('active');
          favBtn.style.transform='translateY(-2px)'; setTimeout(()=>favBtn.style.transform='',130);
          try{
            const {count,isFav} = await favToggle(id, willAdd);
            favLbl.textContent = (count||0).toLocaleString('fa-IR');
            favBtn.classList.toggle('active', isFav);
            if(isFav) addMyFav(id); else removeMyFav(id);
          }catch{}
        });
      }

      // --- preview enrich: add tags/publisher in modal ---
      if(!card._previewEnhanced){
        const orig = window.openPreview;
        window.openPreview = function(c, bid){
          const meta = bookMeta[bid]||{};
          const title = c.querySelector('.title').textContent.replace(/\(\d+ دانلود\)/,'').trim();
          const href  = c.dataset.href;
          const tagsHtml = (meta.tags && meta.tags.length)
            ? meta.tags.map(t=>`<span class="tag-chip">${t}</span>`).join('')
            : '<span style="opacity:.8">—</span>';
          document.getElementById('pvTitle').textContent='پیش‌نمایش «'+title+'»';
          document.getElementById('pvBody').innerHTML =
            `<div>ناشر: <b>${meta.publisher||'—'}</b></div>
             <div>حجم فایل: <b>${meta.size||'نامشخص'}</b></div>
             <div>برچسب‌ها: ${tagsHtml}</div>
             <div>لینک دانلود: ${href?`<a href="${href}" target="_blank" rel="noopener" style="color:#aef">باز کردن</a>`:'نامشخص'}</div>
             <div>امتیاز دیجی‌کالا: <b>${meta.rate==null?'ناموجود':meta.rate}</b> ${meta.votes?`(از ${meta.votes} رأی)`:''}</div>
             <div style="margin-top:6px">خرید: ${meta.buy?`<a href="${meta.buy}" target="_blank" rel="noopener" style="color:#aef">مشاهده در دیجی‌کالا</a>`:'—'}</div>`;
          const pvModal=document.getElementById('previewModal'); pvModal.style.display='flex'; setTimeout(()=>pvModal.classList.add('show'),10);
        }
        card._previewEnhanced=true;
      }

    });
  }

  // Counters for shares & buys
  async function getCounter(type, book){
    const r = await fetch(`/api/counters?type=${type}&book=${encodeURIComponent(book)}`, { cache:'no-store' });
    const d = await r.json(); return (d && typeof d.value==='number') ? d.value : 0;
  }
  async function bumpCounter(type, book, by=1){
    const r = await fetch('/api/counters', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type, book, inc: by }) });
    const d = await r.json(); return (d && typeof d.value==='number') ? d.value : null;
  }

  function wireCounters(){
    document.querySelectorAll('.book-card').forEach(card=>{
      const li=card.closest('li'); const id=li?.dataset?.id; if(!id) return;
      const left=card.querySelector('.left-acts');
      const shareBtn = card.querySelector('.icon-wrap.share');
      const buyBtn   = card.querySelector('.icon-wrap.buy');

      // reuse existing share-label for share count; create buy count label if missing
      let shareLbl = left?.querySelector('.share-label') || null;
      let buyLbl   = left?.querySelector('[data-buycount]') || null;
      if(left && buyBtn && !buyLbl){
        buyLbl = document.createElement('div');
        buyLbl.className='under-txt'; buyLbl.setAttribute('data-buycount','');
        buyLbl.textContent='۰'; left.appendChild(buyLbl);
      }

      // init values
      if(shareLbl) getCounter('shares', id).then(v=> shareLbl.textContent = (v||0).toLocaleString('fa-IR')).catch(()=>{});
      if(buyLbl)   getCounter('buys', id).then(v=> buyLbl.textContent = (v||0).toLocaleString('fa-IR')).catch(()=>{});

      if(shareBtn && !shareBtn._wiredShareCount){
        shareBtn.addEventListener('click', async ()=>{
          try{ const v = await bumpCounter('shares', id, 1);
               if(shareLbl && v!=null) shareLbl.textContent = v.toLocaleString('fa-IR'); }catch{}
        }, true);
        shareBtn._wiredShareCount = true;
      }

      if(buyBtn && !buyBtn._wiredBuyCount){
        buyBtn.addEventListener('click', async ()=>{
          try{ const v = await bumpCounter('buys', id, 1);
               if(buyLbl && v!=null) buyLbl.textContent = v.toLocaleString('fa-IR'); }catch{}
        }, true);
        buyBtn._wiredBuyCount = true;
      }
    });
  }

  // Run
  enhanceCards();
  wireCounters();
  setTimeout(()=>{ enhanceCards(); wireCounters(); }, 400);
})();
</script>

<!-- === Salawat Global Counter (Fixed Alignment) === -->
<div id="gc-widget" style="
  position:fixed; right:16px; bottom:16px; z-index:9999; direction:rtl; font-family:inherit;
  transition: transform .18s ease, opacity .18s ease;
">
  <div style="
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 10px 25px rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    color:#fff; padding:10px 12px; border-radius:14px; min-width:230px;
  ">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px">
      <div style="font-weight:800; font-size:14.5px; text-shadow:0 2px 6px rgba(0,0,0,.45)">
        صلوات‌شمار
      </div>
      <button id="gc-close" aria-label="بستن" title="بستن" style="
        width:26px; height:26px; border:none; border-radius:8px; cursor:pointer; color:#fff;
        background:rgba(255,255,255,.18); box-shadow:0 3px 10px rgba(0,0,0,.3);
        display:flex; align-items:center; justify-content:center; font-weight:900;
        transition: transform .14s ease, background .14s ease;
      ">×</button>
    </div>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <div style="opacity:.95; font-size:13.5px">
        مجموع: <b id="gc-value">—</b>
      </div>
      <button id="gc-inc" style="
        border:none; cursor:pointer; color:#fff;
        background: linear-gradient(135deg,#34d399,#10b981);
        box-shadow: 0 6px 16px rgba(0,0,0,.35);
        border-radius:10px; padding:8px 12px; font-family:inherit;
        transition: transform .12s ease;
      ">+ اضافه</button>
    </div>
  </div>
</div>
<div id="gc-toast" style="
  position:fixed; left:50%; transform:translateX(-50%) translateY(20px);
  bottom:12px; z-index:10000; pointer-events:none;
  opacity:0; transition: opacity .25s ease, transform .25s ease;
">
  <div style="
    background: rgba(0,0,0,.6); color:#fff; padding:10px 14px; border-radius:10px;
    border:1px solid rgba(255,255,255,.2); box-shadow:0 8px 20px rgba(0,0,0,.35);
    font-size:13.5px; backdrop-filter: blur(4px); white-space:nowrap;
  " id="gc-toast-text"></div>
</div>
<script>
(function(){
  const w  = document.getElementById('gc-widget');
  const valEl = document.getElementById('gc-value');
  const btnInc = document.getElementById('gc-inc');
  const btnClose = document.getElementById('gc-close');
  const toast = document.getElementById('gc-toast');
  const toastText = document.getElementById('gc-toast-text');

  btnInc.addEventListener('pointerdown', ()=> btnInc.style.transform='scale(0.96)');
  btnInc.addEventListener('pointerup',   ()=> btnInc.style.transform='scale(1)');

  async function refresh(){
    try{
      const r = await fetch('/api/global-counter',{cache:'no-store'});
      const d = await r.json();
      if(!r.ok || typeof d.value!=='number') throw 0;
      valEl.textContent = d.value.toLocaleString('fa-IR');
    }catch{
      valEl.textContent = 'خطا';
    }
  }

  async function inc(){
    btnInc.disabled = true;
    try{
      const r = await fetch('/api/global-counter', { method:'POST' });
      const d = await r.json();
      if(!r.ok || typeof d.value!=='number') throw 0;
      valEl.textContent = d.value.toLocaleString('fa-IR');
    }catch{
      showToast('نتونستم افزایش بدم؛ دوباره تلاش کن.');
    }finally{
      btnInc.disabled = false;
    }
  }

  function showToast(msg){
    toastText.textContent = msg;
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) translateY(0)';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) translateY(20px)';
    }, 5000);
  }

  function closeWidget(){
    w.style.opacity = '0';
    w.style.transform = 'translateY(10px) scale(0.98)';
    setTimeout(()=>{ w.style.display='none'; }, 180);
    showToast('صلوات‌شمار بسته شد؛ برای برگشتن، صفحه را رفرش کنید.');
  }

  btnInc.addEventListener('click', inc);
  btnClose.addEventListener('click', closeWidget);

  refresh();
})();
</script>
<!-- === /Salawat Global Counter === -->

</body>
</html>
