<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>جغرافیا</title>
<style>
  /* فونت ایران‌یکان X */
  @font-face{
    font-family:'iranyekanX';
    src:url('IRANYekanX-Light.woff2') format('woff2');
  }
  *{box-sizing:border-box}
  body{
    font-family:'iranyekanX',sans-serif;margin:0;padding:0;color:#fff;
    background:radial-gradient(circle at 20% 20%,#e3f2fd,transparent 40%),
               radial-gradient(circle at 80% 25%,#d4fc79,transparent 42%),
               radial-gradient(circle at 20% 80%,#96e6a1,transparent 45%),
               radial-gradient(circle at 80% 75%,#8fd3f4,transparent 40%),
               linear-gradient(180deg,#58a 0%,#2c3e50 100%);
    background-attachment:fixed;min-height:100vh;position:relative;
  }
  body::before{content:"";position:fixed;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.15),rgba(0,0,0,.25));pointer-events:none;z-index:0}
  header{
    text-align:center;font-weight:800;margin:26px 0 10px;font-size:38px;
    background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#fbbf24,#f87171);
    background-size:400% 400%;
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    animation:headGrad 18s ease infinite;text-shadow:0 0 10px rgba(255,255,255,.25);position:relative;z-index:1
  }
  @keyframes headGrad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  /* نوار ابزار */
  .toolbar{width:min(920px,95%);margin:0 auto 8px;display:flex;gap:10px;justify-content:space-between;align-items:center;z-index:2;position:relative}
  .search-box{flex:1;position:relative}
  .search-input{
    width:100%;border:none;border-radius:12px;padding:12px 40px 12px 36px;
    background:rgba(255,255,255,.14);color:#fff;font-family:inherit;outline:none;
    box-shadow:0 8px 18px rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.15)
  }
  .search-input::placeholder{color:#FFFFFF}
  .search-clear{
    position:absolute;left:10px;top:50%;transform:translateY(-50%);
    width:22px;height:22px;border-radius:50%;background:rgba(255,255,255,.2);
    display:none;align-items:center;justify-content:center;cursor:pointer;color:#fff;
    box-shadow:0 4px 10px rgba(0,0,0,.3);font-weight:900
  }
  .search-icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);opacity:.9}
  .sort-btn{
    border:none;border-radius:12px;padding:12px 16px;cursor:pointer;color:#fff;
    background:linear-gradient(135deg,#1C93E3,#2ea3f2);
    box-shadow:0 8px 18px rgba(28,147,227,.4);
    font-family:inherit;
  }

  .panel{
    width:min(920px,95%);margin:12px auto 20px;padding:22px 20px 26px;background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.2);border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.35);
    backdrop-filter:blur(6px);position:relative;z-index:1
  }
  .panel h2{margin:0 0 18px;font-size:22px;color:#f1f5f9;text-shadow:0 2px 8px rgba(0,0,0,.4)}
  ul.books{list-style:none;margin:0;padding:0}
  li{margin:10px 0}

  /* کارت کتاب – grid با ستون آیکون‌ها سمت چپ */
  .book-card{
    display:grid; grid-template-columns:110px 1fr; align-items:center;
    direction:ltr; /* ترتیب ستون‌ها چپ به راست؛ متن داخل rtl می‌ماند */
    gap:10px;text-decoration:none;color:#fff;
    background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.15);padding:14px 14px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.28);transition:transform .18s ease,box-shadow .18s ease,background .18s ease;position:relative
  }
  .book-card:hover{transform:translateY(-3px);background:rgba(255,255,255,.16);box-shadow:0 12px 28px rgba(0,0,0,.45)}
  .title{font-size:16.5px;line-height:1.6;white-space:normal;word-wrap:break-word;text-shadow:0 2px 6px rgba(0,0,0,.45);direction:rtl}
  .dcount{font-size:13px;opacity:.9}

  /* آیکون‌های چپ – گرید ۲×۶ (دو ردیف برچسب برای هر آیکون) */
  .left-acts{
    display:grid;
    grid-template-columns:38px 38px;
    grid-template-rows:38px 14px 38px 14px 38px 14px; /* icon, label, icon, label, icon, label */
    gap:6px 8px; align-items:center; justify-items:center;
    min-width: 110px;
  }
  .left-acts .icon-wrap{
    width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;
    border-radius:10px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
    box-shadow:0 6px 16px rgba(0,0,0,.35); transition:transform .15s ease, background .15s ease
  }
  .left-acts .icon-wrap:hover{ transform:translateY(-2px); background:rgba(255,255,255,.16) }
  .left-acts svg{ width:22px;height:22px; fill:#fff; filter: drop-shadow(0 2px 4px rgba(0,0,0,.45));}
  .under-txt, .under-txt2{font-size:11.5px;color:#eaeaea;direction:rtl}
  /* جایگذاری در گرید */
  .dl{grid-column:1;grid-row:1}
  .u-size{grid-column:1;grid-row:2}
  .star{grid-column:2;grid-row:1}
  .u-rate{grid-column:2;grid-row:2}
  .share{grid-column:1;grid-row:3}
  .buy{grid-column:2;grid-row:3}
  .cmt{grid-column:1;grid-row:5}
  .u-cmc{grid-column:1;grid-row:6}

  /* پیام ستاره (tooltip) */
  .star-tip{
    position:absolute; right:110px; bottom:10px; background:rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.15); color:#fff; font-size:12.5px; padding:6px 10px; border-radius:10px;
    box-shadow:0 10px 25px rgba(0,0,0,.35);
    opacity:0; transform:translateY(12px); pointer-events:none; transition:all .35s ease;
    max-width: 68%; line-height:1.8; direction:rtl
  }
  .star-tip.show{ opacity:1; transform:translateY(0) }
  .star-tip.hide{ opacity:0; transform:translateY(18px) }

  .btn-back{
    display:inline-block;margin:24px auto 10px;background:linear-gradient(135deg,#1C93E3,#2ea3f2);padding:12px 26px;color:#fff;text-decoration:none;border-radius:12px;box-shadow:0 8px 18px rgba(28,147,227,.4);transition:transform .15s ease, box-shadow .15s ease
  }
  .btn-back:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(28,147,227,.6)}

  #counter{text-align:center;margin:12px 0 24px;font-size:15px;color:#eaeaea;text-shadow:0 2px 6px rgba(0,0,0,.45)}

  /* مودال پیش‌نمایش */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.5); z-index:50 }
  .modal .box{
    width:min(680px,92%); border-radius:16px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2);
    box-shadow:0 18px 40px rgba(0,0,0,.45); padding:14px 16px; backdrop-filter:blur(6px); color:#fff; position:relative; transform:scale(.95); opacity:0; transition: all .25s ease; direction:rtl
  }
  .modal.show .box{ transform:scale(1); opacity:1; }
  .modal h3{ margin:6px 0 12px; font-size:18px }
  .modal .row{ display:flex; gap:8px; justify-content:flex-end; align-items:center; margin-top:8px; flex-wrap:wrap }
  .btn{ border:none; border-radius:10px; padding:8px 16px; cursor:pointer; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.35); background:linear-gradient(135deg,#34d399,#10b981); font-family:inherit }
  .btn.gray{ background:linear-gradient(135deg,#64748b,#475569) }

  /* مودال مرتب‌سازی */
  .modal-sort{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.5); z-index:60; }
  .modal-sort .box{
    width:min(520px,92%); border-radius:16px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2);
    box-shadow:0 18px 40px rgba(0,0,0,.45); padding:14px 16px; backdrop-filter:blur(6px); color:#fff; position:relative; transform:scale(.94); opacity:0; transition: all .2s ease; direction:rtl
  }
  .modal-sort.show .box{ transform:scale(1); opacity:1; }
  .sort-title{ font-size:16px; margin-bottom:10px }
  .sort-list{ list-style:none; margin:0; padding:0 }
  .sort-list li{
    margin:8px 0; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.15);
    cursor:pointer; transition: all .15s ease;
  }
  .sort-list li:hover{ background: rgba(255,255,255,.16) }
  .sort-list li.active{ background: linear-gradient(135deg,#34d399,#10b981) }
  .modal-sort .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }

  /* مودال دیدگاه‌ها */
  .modal-cmt{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.5); z-index:70 }
  .modal-cmt .box{
    width:min(720px,94%); border-radius:16px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2);
    box-shadow:0 18px 40px rgba(0,0,0,.45); padding:12px 14px; backdrop-filter:blur(6px); color:#fff; position:relative; transform:scale(.96); opacity:0; transition: all .25s ease; direction:rtl
  }
  .modal-cmt.show .box{ transform:scale(1); opacity:1; }
  .cmt-list{ list-style:none; margin:8px 0 10px; padding:0; max-height: 260px; overflow-y:auto }
  .cmt-item{ background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:8px 10px; margin:8px 0 }
  .cmt-head{ font-size:13px; opacity:.9; display:flex; gap:8px; align-items:center; justify-content:space-between }
  .cmt-user{ font-weight:600 }
  .cmt-time{ font-size:12px; opacity:.9 }
  .cmt-text{ margin-top:6px; line-height:1.9; white-space:pre-wrap }
  .cmt-act{ display:flex; gap:10px; margin-top:6px; opacity:.95 }
  .cmt-act span{ cursor:pointer; font-size:12.5px; color:#aef }
  .cmt-replyto{ font-size:12px; opacity:.9; margin-top:4px }
  .reply-selected{
    background:rgba(255,255,255,.14); border:1px dashed rgba(255,255,255,.3);
    padding:6px 8px; border-radius:10px; margin:6px 0; font-size:12.5px
  }
  .cmt-input{ width:100%; min-height:60px; border:none; border-radius:10px; padding:10px; resize:vertical; font-family:inherit; background:rgba(255,255,255,.86); color:#000 }
</style>
</head>
<body>
<header>جغرافیا 📘</header>

<div class="toolbar">
  <div class="search-box">
    <input id="searchInput" class="search-input" type="text" placeholder="جست‌وجو بین کتاب‌ها"/>
    <span class="search-icon">🔎</span>
    <span id="searchClear" class="search-clear">×</span>
  </div>
  <button id="btnSort" class="sort-btn">مرتب‌سازی: پیش‌فرض</button>
</div>

<!-- یازدهم -->
<section class="panel" data-panel="11">
  <h2>کتاب‌های جغرافیا، پایه یازدهم</h2>
  <ul class="books" id="list11">
    <li data-id="geo11-test">
      <div class="book-card" data-href="https://mega.nz/file/EygHRLaZ#XYM70813eKudH6DVdHsdduHbCb9I5d-W6NqhVDMngfs">
        <div class="left-acts">
          <!-- ردیف 1 -->
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
          </div>
          <!-- ردیف 2 (برچسب‌ها) -->
          <div class="under-txt u-size" data-size>88 MB</div>
          <div class="under-txt2 u-rate" data-rate>؟</div>
          <!-- ردیف 3 -->
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.28 3.28 0 000-1.39l7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34-3 3c0 .23.03.45.08.66L7.91 9.77A2.99 2.99 0 006 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.73 0 1.4-.26 1.91-.69l7.21 4.2c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5L4 6H0v2h2l3.6 7.59c-.35.59-.6 1.27-.6 2.01A3.5 3.5 0 008.5 21c1.61 0 2.96-1.07 3.36-2.5h2.28A3.5 3.5 0 0017.5 21 3.5 3.5 0 0021 17.5c0-1.23-.66-2.29-1.64-2.86ل1.66-7.64H7V4zm0 4h11.1l-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <!-- ردیف 5 -->
          <div class="icon-wrap cmt" title="نظرات">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt2 u-cmc" data-cmc>0</div>
        </div>
        <span class="title">پرسش‌های چهارگزینه‌ای (به همراه درسنامه) – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
        <div class="star-tip"></div>
      </div>
    </li>

    <li data-id="geo11-shab">
      <div class="book-card" data-href="https://mega.nz/file/R2YkAK7L#s2sUeQnr4IZ4IEx2vr9vFQMNZmSAcdDw4ggAtAatlqw">
        <div class="left-acts">
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8ل4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587ل3.668 7.431L24 9.753ل-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6ل15.6 0 9.753ل8.332-1.735z"/></svg>
          </div>
          <div class="under-txt u-size" data-size>23 MB</div>
          <div class="under-txt2 u-rate" data-rate>4.4</div>
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77ل8.91 12.7a3.28 3.28 0 000-1.39ل7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34ل-3 3c0 .23.03.45.08.66ل7.91 9.77A2.99 2.99 0 006 9c-1.66 0-3 1.34-3 3س1.34 3 3 3 c.73 0 1.4-.26 1.91-.69ل7.21 4.2c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5ل4 6H0v2h2ل3.6 7.59c-.35.59-.6 1.27-.6 2.01A3.5 3.5 0 008.5 21c1.61 0 2.96-1.07 3.36-2.5h2.28A3.5 3.5 0 0017.5 21 3.5 3.5 0 0021 17.5c0-1.23-.66-2.29-1.64-2.86ل1.66-7.64H7V4zm0 4h11.1ل-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <div class="icon-wrap cmt" title="نظرات">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18ل4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt2 u-cmc" data-cmc>0</div>
        </div>
        <span class="title">شب امتحان – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
        <div class="star-tip"></div>
      </div>
    </li>
  </ul>
</section>

<!-- دهم -->
<section class="panel" data-panel="10">
  <h2>کتاب‌های جغرافیا، پایه دهم</h2>
  <ul class="books" id="list10">
    <li data-id="geo10-shab">
      <div class="book-card" data-href="https://s32.picofile.com/file/8481978634/%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7_%D8%AF%D9%87%D9%85%D8%8C_%D8%B4%D8%A8_%D8%A7%D9%85%D8%AA%D8%AD%D8%A7%D9%86_B_U_L.pdf.html">
        <div class="left-acts">
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16ل4-5h-3V4h-2v7H8ل4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587ل3.668 7.431L24 9.753ل-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6ل15.6 0 9.753ل8.332-1.735z"/></svg>
          </div>
          <div class="under-txt u-size" data-size>24 MB</div>
          <div class="under-txt2 u-rate" data-rate>4.5</div>
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77ل8.91 12.7a3.28 3.28 0 000-1.39ل7.05-4.11A2.99 2.99 0 0018 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34ل-3 3c0 .23.03.45.08.66ل7.91 9.77A2.99 2.99 0 006 9س-1.66 0-3 1.34-3 3س1.34 3 3 3 c.73 0 1.4-.26 1.91-.69ل7.21 4.2c-.05.2-.08.41-.08.63A3 3 0 1018 16.08z"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5ل4 6H0v2h2ل3.6 7.59c-.35.59-.6 1.27-.6 2.01A3.5 3.5 0 008.5 21س1.61 0 2.96-1.07 3.36-2.5h2.28A3.5 3.5 0 0017.5 21س3.5 3.5 0 0021 17.5c0-1.23-.66-2.29-1.64-2.86ل1.66-7.64H7V4zm0 4h11.1ل-1.25 5.75H8.53L7 8z"/></svg>
          </div>
          <div class="icon-wrap cmt" title="نظرات">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18ل4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
          </div>
          <div class="under-txt2 u-cmc" data-cmc>0</div>
        </div>
        <span class="title">شب امتحان – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
        <div class="star-tip"></div>
      </div>
    </li>

    <li data-id="geo10-dars">
      <div class="book-card" data-href="https://s32.picofile.com/file/8481961634/%D8%AF%D8%B1%D8%B3%D9%86%D8%A7%D9%85%D9%87_%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7_%D8%AF%D9%87%D9%85_%D8%A8%D8%B1_%D8%B9%D9%85%D8%B1_%D9%84%D8%B9%D9%86%D8%AA.pdf.html">
        <div class="left-acts">
          <div class="icon-wrap dl" title="دانلود">
            <svg viewBox="0 0 24 24"><path d="M12 16ل4-5h-3V4h-2v7H8ل4 5zm8 2H4v2h16v-2z"/></svg>
          </div>
          <div class="icon-wrap star" title="امتیاز">
            <svg viewBox="0 0 24 24"><path d="M12 .587ل3.668 7.431L24 9.753ل-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6ل15.6 0 9.753ل8.332-1.735z"/></svg>
          </div>
          <div class="under-txt u-size" data-size>36 MB</div>
          <div class="under-txt2 u-rate" data-rate>4.2</div>
          <div class="icon-wrap share" title="اشتراک‌گذاری">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77ل8.91 12.7a3.28 3.28 0 000-1.39ل7.05-4.11A2.99 2.99 0 0018 7.91س1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34ل-3 3c0 .23.03.45.08.66ل7.91 9.77A2.99 2.99 0 006 9س-1.66 0-3 1.34-3 3س1.34 3 3 3 c.73 0 1.4-.26 1.91-.69ل7.21 4.2c-.05.2-.08.41-.08.63A3 3 0 1018 16.08ز"/></svg>
          </div>
          <div class="icon-wrap buy" title="خرید">
            <svg viewBox="0 0 24 24"><path d="M7 4H5ل4 6H0v2h2ل3.6 7.59c-.35.59-.6 1.27-.6 2.01A3.5 3.5 0 008.5 21س1.61 0 2.96-1.07 3.36-2.5h2.28A3.5 3.5 0 0017.5 21س3.5 3.5 0 0021 17.5c0-1.23-.66-2.29-1.64-2.86ل1.66-7.64H7V4zm0 4h11.1ل-1.25 5.75H8.53L7 8ز"/></svg>
          </div>
          <div class="icon-wrap cmt" title="نظرات">
            <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18ل4-4h14a2 2 0 002-2V4a2 2 0 00-2-2ز"/></svg>
          </div>
          <div class="under-txt2 u-cmc" data-cmc>0</div>
        </div>
        <span class="title">درسنامه جغرافیا – خیلی سبز <span class="dcount" data-dlc>(0 دانلود)</span></span>
        <div class="star-tip"></div>
      </div>
    </li>
  </ul>
</section>

<div style="text-align:center">
  <a class="btn-back" href="index.html">بازگشت به منوی اصلی</a>
</div>

<div id="counter"><span id="visit-count">در حال بارگذاری...</span></div>

<!-- مودال‌ها: پیش‌نمایش -->
<div class="modal" id="previewModal">
  <div class="box">
    <h3 id="pvTitle">پیش‌نمایش</h3>
    <div id="pvBody" style="line-height:1.9;font-size:14.5px;opacity:.95"></div>
    <div class="row"><button id="pvClose" class="btn gray">بستن</button></div>
  </div>
</div>

<!-- مودال مرتب‌سازی -->
<div class="modal-sort" id="sortModal">
  <div class="box">
    <div class="sort-title">مرتب‌سازی بر اساس</div>
    <ul class="sort-list" id="sortList">
      <li data-sort="default" class="active">پیش‌فرض</li>
      <li data-sort="rate">بیشترین امتیاز</li>
      <li data-sort="downloads">بیشترین دانلود</li>
      <li data-sort="size">کم‌حجم‌ترین</li>
    </ul>
    <div class="row"><button class="btn gray" id="btnSortClose">بستن</button></div>
  </div>
</div>

<!-- مودال نظرات -->
<div class="modal-cmt" id="cmtModal">
  <div class="box">
    <h3 id="cmtTitle">نظرات</h3>
    <div id="replySel" class="reply-selected" style="display:none"></div>
    <ul class="cmt-list" id="cmtList"></ul>
    <textarea id="cmtInput" class="cmt-input" placeholder="نظر خود را بنویسید..."></textarea>
    <div class="row">
      <button class="btn" id="sendCmt">ارسال نظر</button>
      <button class="btn gray" id="closeCmt">بستن</button>
    </div>
  </div>
</div>

<script>
  // -- شمارنده بازدید صفحه --
  async function loadVisits(){
    const slug='geography';
    try{
      const r=await fetch(`/api/visits?slug=${encodeURIComponent(slug)}`,{cache:'no-store'});
      const d=await r.json();
      if(!r.ok||typeof d.value!=='number')throw 0;
      document.getElementById('visit-count').textContent=`بازدید این صفحه: ${d.value}`;
      await fetch(`/api/log?slug=${encodeURIComponent(slug)}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ua:navigator.userAgent})
      });
    }catch{
      document.getElementById('visit-count').textContent='خطا در دریافت شمارنده';
    }
  }
  loadVisits();

  // -- داده‌های ثابت کتاب‌ها --
  const bookMeta={
    'geo11-test':{size:'88 MB',rate:null,votes:null,buy:'https://www.digikala.com/product/dkp-9512809/کتاب-پرسش-های-چهارگزینه-ای-جغرافیا-2-اثر-زهرا-نعمتی-و-الهه-همایون-زاده-انتشارات-خیلی-سبز/'},
    'geo11-shab':{size:'23 MB',rate:4.4,votes:26,buy:'https://www.digikala.com/product/dkp-820916/کتاب-شب-امتحان-جغرافیا-پایه-یازدهم-اثر-سیده-مریم-طاهری/'},
    'geo10-shab':{size:'24 MB',rate:4.5,votes:67,buy:'https://www.digikala.com/product/dkp-4123378/کتاب-شب-امتحان-جغرافیا-ایران-دهم-اثر-مهدی-کاردان-و-شادی-کاریان-انتشارات-خیلی-سبز/'},
    'geo10-dars':{size:'36 MB',rate:4.2,votes:45,buy:'https://www.digikala.com/product/dkp-1874006/کتاب-پرسش-های-چهار-گزینه-ای-جغرافیا-جامع-دهم-و-یازدهم-و-دوازدهم-رشته-انسانی-اثر-زهرا-نعمتی-و-الهه-همایون-زاده-انتشارات-خیلی-سبز/'}
  };

  // device id برای حذف محلی و تعیین کاربر ساده
  const devId=(localStorage.getItem('device_id')||(()=>{const v='dev_'+Math.random().toString(36).slice(2);localStorage.setItem('device_id',v);return v})());

  function lsGet(k,d){ try{return JSON.parse(localStorage.getItem(k))??d}catch{return d} }
  function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

  // -- دانلودها (Upstash) --
  async function getDownloads(book){
    try{
      const r=await fetch(`/api/downloads?book=${encodeURIComponent(book)}`,{cache:'no-store'});
      const d=await r.json(); if(!r.ok||typeof d.value!=='number') throw 0;
      return d.value;
    }catch{return lsGet('dl_'+book,0)}
  }
  async function addDownload(book){
    try{
      const r=await fetch('/api/downloads',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({book,inc:1})});
      const d=await r.json(); if(!r.ok||typeof d.value!=='number') throw 0;
      return d.value;
    }catch{
      const v=lsGet('dl_'+book,0)+1; lsSet('dl_'+book,v); return v;
    }
  }

  // --- جست‌وجو
  const searchInput=document.getElementById('searchInput');
  const searchClear=document.getElementById('searchClear');
  function normalize(s){return (s||'').replace(/\s+/g,' ').toLowerCase()}
  function filterBooks(){
    const v=normalize(searchInput.value||'');
    document.querySelectorAll('.books li').forEach(li=>{
      const t=li.querySelector('.title').textContent;
      li.style.display = normalize(t).includes(v) ? '' : 'none';
    });
    searchClear.style.display = v? 'flex':'none';
  }
  searchInput.addEventListener('input',filterBooks);
  searchClear.addEventListener('click',()=>{searchInput.value='';filterBooks();searchInput.focus()});

  // --- مرتب سازی
  const sortBtn=document.getElementById('btnSort');
  const sortModal=document.getElementById('sortModal');
  const sortList=document.getElementById('sortList');
  const sortClose=document.getElementById('btnSortClose');
  let currentSort='default';
  function openSort(){sortModal.style.display='flex';setTimeout(()=>sortModal.classList.add('show'),10)}
  function closeSort(){sortModal.classList.remove('show');setTimeout(()=>sortModal.style.display='none',160)}
  sortBtn.addEventListener('click',openSort);
  sortClose.addEventListener('click',closeSort);
  sortModal.addEventListener('click',e=>{if(e.target===sortModal)closeSort()});
  sortList.querySelectorAll('li').forEach(li=>{
    li.addEventListener('click',async()=>{
      sortList.querySelectorAll('li').forEach(x=>x.classList.remove('active'));
      li.classList.add('active'); currentSort=li.dataset.sort;
      await applySort(); sortBtn.textContent='مرتب‌سازی: '+li.textContent.trim(); closeSort();
    })
  });

  async function applySort(){
    const items=[...document.querySelectorAll('.books li')].map(li=>{
      const id=li.dataset.id, meta=bookMeta[id]||{};
      const dlNum=parseInt((li.querySelector('[data-dlc]').textContent.match(/\d+/)||[0])[0],10)||0;
      return {
        li,id,
        size: meta.size?parseInt(meta.size):9999999,
        rate: (meta.rate==null?-1:meta.rate),
        downloads: dlNum
      };
    });

    switch(currentSort){
      case 'rate': items.sort((a,b)=>b.rate-a.rate); break;
      case 'downloads': items.sort((a,b)=>b.downloads-a.downloads); break;
      case 'size': items.sort((a,b)=>a.size-b.size); break;
      default: break;
    }

    const list11=document.getElementById('list11'), list10=document.getElementById('list10');
    items.forEach(it=>{
      const p=it.li.closest('.panel');
      if(p.dataset.panel==='11') list11.appendChild(it.li);
      else list10.appendChild(it.li);
    });
  }

  // --- مودال پیش‌نمایش
  const pvModal=document.getElementById('previewModal');
  const pvTitle=document.getElementById('pvTitle');
  const pvBody=document.getElementById('pvBody');
  const pvClose=document.getElementById('pvClose');
  pvClose.addEventListener('click',()=>{pvModal.classList.remove('show');setTimeout(()=>pvModal.style.display='none',180)});
  pvModal.addEventListener('click',e=>{if(e.target===pvModal) pvClose.click()});

  function openPreview(card,id){
    const title = card.querySelector('.title').textContent.replace(/\(\d+ دانلود\)/,'').trim();
    const href  = card.dataset.href;
    const meta  = bookMeta[id]||{};
    pvTitle.textContent='پیش‌نمایش «'+title+'»';
    pvBody.innerHTML =
      `<div>حجم فایل: <b>${meta.size||'نامشخص'}</b></div>
       <div>لینک دانلود: ${href?`<a href="${href}" target="_blank" rel="noopener" style="color:#aef">باز کردن</a>`:'نامشخص'}</div>
       <div>امتیاز دیجی‌کالا: <b>${meta.rate==null?'ناموجود':meta.rate}</b> ${meta.votes?`(از ${meta.votes} رأی)`:''}</div>
       <div style="margin-top:6px">خرید: ${meta.buy?`<a href="${meta.buy}" target="_blank" rel="noopener" style="color:#aef">مشاهده در دیجی‌کالا</a>`:'—'}</div>`;
    pvModal.style.display='flex'; setTimeout(()=>pvModal.classList.add('show'),10);
  }

  // --- مودال نظرات
  const cmtModal=document.getElementById('cmtModal');
  const cmtTitle=document.getElementById('cmtTitle');
  const cmtList=document.getElementById('cmtList');
  const cmtInput=document.getElementById('cmtInput');
  const sendCmt=document.getElementById('sendCmt');
  const closeCmt=document.getElementById('closeCmt');
  const replySel=document.getElementById('replySel');

  let currentBook=null, replyTo=null, currentCmtCounterEl=null;

  function openCmtModal(bookId,title,counterEl){
    currentBook=bookId; replyTo=null; currentCmtCounterEl=counterEl;
    cmtTitle.textContent='نظرات «'+title+'»';
    cmtInput.value=''; replySel.style.display='none'; replySel.textContent='';
    loadAndRenderComments();
    cmtModal.style.display='flex'; setTimeout(()=>cmtModal.classList.add('show'),10);
  }
  function closeCmtModal(){ cmtModal.classList.remove('show'); setTimeout(()=>cmtModal.style.display='none',180) }
  closeCmt.addEventListener('click',closeCmtModal);
  cmtModal.addEventListener('click',e=>{ if(e.target===cmtModal) closeCmtModal() });

  // (الف) دریافت دیدگاه‌ها (آپدیت‌شده)
  async function fetchComments(bookId){
    const r=await fetch(`/api/comments?slug=${encodeURIComponent(bookId)}`,{cache:'no-store'});
    if(!r.ok) throw new Error('fetch error');
    return r.json(); // array
  }
  // ارسال دیدگاه
  async function postComment(bookId,text,parentId){
    const r=await fetch(`/api/comments?slug=${encodeURIComponent(bookId)}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ text, parentId: parentId||null, userId: devId })
    });
    return r.json();
  }
  // حذف محلی نرم
  function markHidden(bookId, cmtId){
    const key='hidden_'+bookId, arr=lsGet(key,[]);
    if(!arr.includes(cmtId)){ arr.push(cmtId); lsSet(key,arr) }
  }
  function isHidden(bookId,cmtId){
    const key='hidden_'+bookId, arr=lsGet(key,[]);
    return arr.includes(cmtId);
  }

  // (ب) تاریخ شمسی با ساعت/دقیقه (آپدیت‌شده)
  function faDate(ts){
    const t = Number(ts);
    const d = new Date(Number.isFinite(t) ? t : 0);
    if(isNaN(d.getTime())) return '—';
    const dateStr = d.toLocaleDateString('fa-IR');
    const timeStr = d.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
    return `${dateStr} - ${timeStr}`;
  }

  // (ج) رندر مشاهده‌ی دیدگاه‌ها (آپدیت‌شده: استفاده از String(doc.text))
  function renderComments(list){
    cmtList.innerHTML='';
    const filtered=list.filter(doc=>!isHidden(currentBook,doc.id));
    filtered.forEach(doc=>{
      const li=document.createElement('li');
      li.className='cmt-item';

      const head=document.createElement('div');
      head.className='cmt-head';
      const leftInfo=document.createElement('div');
      const user=document.createElement('span');
      user.className='cmt-user';
      user.textContent='کاربر ناشناس';
      const time=document.createElement('span');
      time.className='cmt-time';
      time.textContent=faDate(doc.time);
      leftInfo.appendChild(user);

      const rightInfo=document.createElement('div');
      rightInfo.appendChild(time);
      head.appendChild(leftInfo);
      head.appendChild(rightInfo);

      const body=document.createElement('div');
      body.className='cmt-text';
      body.textContent=String(doc.text||'');

      const act=document.createElement('div');
      act.className='cmt-act';
      const btnReply=document.createElement('span');
      btnReply.textContent='پاسخ';
      btnReply.addEventListener('click',()=>{
        replyTo=doc;
        replySel.style.display='block';
        replySel.innerHTML=`در حال پاسخ به: <b>${String(doc.text).slice(0,40)}...</b> <span style="cursor:pointer;color:#fbb"> (لغو) </span>`;
        replySel.querySelector('span').addEventListener('click',()=>{ replyTo=null; replySel.style.display='none'; replySel.textContent='' });
        cmtInput.focus();
      });
      const btnDel=document.createElement('span');
      btnDel.textContent='حذف';
      btnDel.addEventListener('click',()=>{
        if(confirm('این نظر روی این دستگاه مخفی می‌شود. ادامه می‌دهید؟')){
          markHidden(currentBook, doc.id);
          loadAndRenderComments();
        }
      });
      act.appendChild(btnReply);
      // فقط اجازه حذف محلی برای همه (ساده)
      act.appendChild(btnDel);

      li.appendChild(head);
      if(doc.parentId){
        const rep=document.createElement('div');
        rep.className='cmt-replyto';
        rep.textContent='پاسخ به یک نظر';
        li.appendChild(rep);
      }
      li.appendChild(body);
      li.appendChild(act);
      cmtList.appendChild(li);
    });

    // کنتور کنار آیکن
    if(currentCmtCounterEl){
      currentCmtCounterEl.textContent = String(filtered.length);
    }
  }

  async function loadAndRenderComments(){
    try{
      const arr=await fetchComments(currentBook);
      renderComments(arr);
    }catch(e){
      alert('خطا در دریافت نظرات');
    }
  }

  sendCmt.addEventListener('click', async()=>{
    const txt=(cmtInput.value||'').trim();
    if(!txt) return;
    try{
      const res=await postComment(currentBook, txt, replyTo? replyTo.id:null);
      if(!res || res.ok===false){
        alert('خطا در ارسال نظر'); return;
      }
      cmtInput.value='';
      replyTo=null; replySel.style.display='none'; replySel.textContent='';
      await loadAndRenderComments();
    }catch(e){
      alert('خطا در ارسال نظر');
    }
  });

  // --- کارت‌ها
  const pvModalEl=document.getElementById('previewModal');
  function initCards(){
    document.querySelectorAll('.book-card').forEach(card=>{
      const li=card.closest('li'); const id=li.dataset.id;
      const titleEl=card.querySelector('.title');
      const countEl=card.querySelector('[data-dlc]');
      const starTip=card.querySelector('.star-tip');
      const meta=bookMeta[id]||{};
      // کنتور دانلود
      getDownloads(id).then(v=>{countEl.textContent=`(${v} دانلود)`});

      // ستاره
      card.querySelector('.icon-wrap.star').addEventListener('click',e=>{
        e.stopPropagation();
        let msg = (meta.rate==null)?'برای این کتاب امتیازی در دیجی‌کالا ثبت نشده است':`${meta.rate} از 5 بر اساس ${meta.votes} رأی در دیجی‌کالا`;
        starTip.textContent = msg;
        starTip.classList.remove('hide'); starTip.classList.add('show');
        setTimeout(()=>{ starTip.classList.remove('show'); starTip.classList.add('hide') }, 6000); // 6 ثانیه
      });

      // خرید
      card.querySelector('.icon-wrap.buy').addEventListener('click',e=>{
        e.stopPropagation();
        if(meta.buy) window.open(meta.buy,'_blank','noopener');
      });

      // اشتراک‌گذاری
      card.querySelector('.icon-wrap.share').addEventListener('click',async e=>{
        e.stopPropagation();
        const t=titleEl.textContent.replace(/\(\d+ دانلود\)/,'').trim();
        const url=location.href;
        if(navigator.share){ try{ await navigator.share({title:t,text:'کتاب پیشنهادی:',url}); }catch{} }
        else{
          try{ await navigator.clipboard.writeText(`${t}\n${url}`); alert('لینک صفحه کپی شد') }catch{ alert('کپی نشد؛ دستی کپی کنید.') }
        }
      });

      // دانلود
      card.querySelector('.icon-wrap.dl').addEventListener('click',async e=>{
        e.stopPropagation();
        const nv=await addDownload(id); countEl.textContent=`(${nv} دانلود)`;
        const href=card.dataset.href; if(href) window.open(href,'_blank','noopener');
      });

      // نظرات
      const cmtIcon = card.querySelector('.icon-wrap.cmt');
      const cmtCounterEl = card.querySelector('[data-cmc]');
      if(cmtIcon){
        cmtIcon.addEventListener('click', async e=>{
          e.stopPropagation();
          const title = titleEl.textContent.replace(/\(\d+ دانلود\)/,'').trim();
          openCmtModal(id,title,cmtCounterEl);
        });
        // بارگذاری تعداد برای نمایش اولیه
        try{
          const arr=await fetchComments(id);
          const filtered= arr.filter(doc=>!isHidden(id,doc.id));
          cmtCounterEl.textContent=String(filtered.length||0);
        }catch{}
      }

      // کلیک روی بدنه کارت -> فقط پیش‌نمایش
      card.addEventListener('click',()=> openPreview(card,id));
    });
  }
  initCards();
</script>
</body>
</html>
