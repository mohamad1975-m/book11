<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¬ØºØ±Ø§ÙÛŒØ§</title>
  <style>
    @font-face {
      font-family: 'iranyekan';
      src: url('iranyekanweblight.woff') format('woff');
    }
    *{box-sizing:border-box}
    body{
      font-family:'iranyekan',sans-serif;margin:0;padding:0;color:#fff;
      background:radial-gradient(circle at 20% 20%,#e3f2fd,transparent 40%),
                 radial-gradient(circle at 80% 25%,#d4fc79,transparent 42%),
                 radial-gradient(circle at 20% 80%,#96e6a1,transparent 45%),
                 radial-gradient(circle at 80% 75%,#8fd3f4,transparent 40%),
                 linear-gradient(180deg,#58a 0%,#2c3e50 100%);
      background-attachment:fixed;min-height:100vh;position:relative;
    }
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.15),rgba(0,0,0,.25));pointer-events:none;z-index:0}
    header{
      text-align:center;font-weight:800;margin:26px 0 10px;font-size:38px;
      background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#fbbf24,#f87171);
      background-size:400% 400%;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      animation:headGrad 18s ease infinite;text-shadow:0 0 10px rgba(255,255,255,.25);position:relative;z-index:1
    }
    @keyframes headGrad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .panel{
      width:min(920px,95%);margin:20px auto;padding:22px 20px 26px;background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.2);border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.35);
      backdrop-filter:blur(6px);position:relative;z-index:1
    }
    .panel h2{margin:0 0 18px;font-size:22px;color:#f1f5f9;text-shadow:0 2px 8px rgba(0,0,0,.4)}
    ul.books{list-style:none;margin:0;padding:0}
    li{margin:10px 0}

    .book-card{
      display:flex;align-items:center;justify-content:space-between;gap:10px;text-decoration:none;color:#fff;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.15);padding:16px 18px;border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.28);transition:transform .18s ease,box-shadow .18s ease,background .18s ease;position:relative
    }
    .book-card:hover{transform:translateY(-3px);background:rgba(255,255,255,.16);box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .book-card .title{font-size:16.5px;line-height:1.6;white-space:normal;word-wrap:break-word;flex:1;text-shadow:0 2px 6px rgba(0,0,0,.45)}

    /* Ø¯Ø§Ù†Ù„ÙˆØ¯ (Ú†Ù¾ Ú©Ø§Ø±Øª) */
    .book-card .badge{
      width:26px;height:26px;margin-left:12px;flex-shrink:0;display:inline-flex;align-items:center;justify-content:center;order:-1
    }
    .book-card .badge svg{width:100%;height:100%;fill:#fff;filter:drop-shadow(0 2px 4px rgba(0,0,0,.45))}

    /* Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª: Ø³ØªØ§Ø±Ù‡ + Ù¾ÛŒØ§Ù… */
    .actions{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:48px}
    .action-btn{width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,.45));transition:transform .15s ease}
    .action-btn:hover{transform:translateY(-2px)}
    .action-btn svg{width:100%;height:100%;fill:#fff}
    .meta{font-size:11.5px;color:#eaeaea;text-shadow:0 2px 6px rgba(0,0,0,.45)}

    .btn-back{display:inline-block;margin:24px auto 10px;background:linear-gradient(135deg,#1C93E3,#2ea3f2);padding:12px 26px;color:#fff;text-decoration:none;border-radius:12px;box-shadow:0 8px 18px rgba(28,147,227,.4);transition:transform .15s ease, box-shadow .15s ease}
    .btn-back:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(28,147,227,.6)}

    #counter{text-align:center;margin:20px 0 30px;font-size:15px;color:#eaeaea;text-shadow:0 2px 6px rgba(0,0,0,.45)}

    /* Ù…ÙˆØ¯Ø§Ù„ Ù†Ø¸Ø±Ø§Øª/Ø§Ù…ØªÛŒØ§Ø² */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
    .modal .box{width:min(680px,92%);border-radius:16px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);box-shadow:0 18px 40px rgba(0,0,0,.45);padding:14px 16px;backdrop-filter:blur(6px);color:#fff}
    .modal h3{margin:6px 0 12px;font-size:18px}
    .cmt-list{list-style:none;margin:0 0 8px;padding:0;max-height:220px;overflow-y:auto}
    .cmt-list li{padding:8px 10px;margin:6px 0;background:rgba(255,255,255,.1);border-radius:10px;text-shadow:0 1px 4px rgba(0,0,0,.5);font-size:14.5px;line-height:1.7}
    .modal textarea{width:100%;min-height:70px;border-radius:10px;border:none;padding:10px;resize:vertical;font-family:inherit}
    .modal .row{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:8px;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:8px 16px;cursor:pointer;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.35);background:linear-gradient(135deg,#34d399,#10b981);font-family:inherit}
    .btn.gray{background:linear-gradient(135deg,#64748b,#475569)}
    .rate-row{display:flex;align-items:center;gap:12px;margin:8px 0 2px}
    .rate-stars span{font-size:22px;cursor:pointer;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))}
  </style>
</head>
<body>
  <header>Ø¬ØºØ±Ø§ÙÛŒØ§ ğŸ“˜</header>

  <!-- ÛŒØ§Ø²Ø¯Ù‡Ù… -->
  <section class="panel">
    <h2>Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø¬ØºØ±Ø§ÙÛŒØ§ØŒ Ù¾Ø§ÛŒÙ‡ ÛŒØ§Ø²Ø¯Ù‡Ù…</h2>
    <ul class="books">
      <li>
        <a class="book-card" href="https://mega.nz/file/EygHRLaZ#XYM70813eKudH6DVdHsdduHbCb9I5d-W6NqhVDMngfs"
           target="_blank" rel="noopener"
           data-id="geo11-test" data-title="Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ÛŒ Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡) â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²">
          <!-- Ø¯Ø§Ù†Ù„ÙˆØ¯ (Ú†Ù¾) -->
          <span class="badge">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
          </span>
          <!-- Ø¹Ù†ÙˆØ§Ù† -->
          <span class="title">Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ÛŒ Ú†Ù‡Ø§Ø±Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ (Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡) â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²</span>
          <!-- Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø³Øª -->
          <div class="actions">
            <div class="action-btn rate-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
            </div>
            <div class="meta rate-avg"></div>
            <div class="action-btn cmt-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
            </div>
            <div class="meta cmt-count"></div>
          </div>
        </a>
      </li>

      <li>
        <a class="book-card" href="https://mega.nz/file/R2YkAK7L#s2sUeQnr4IZ4IEx2vr9vFQMNZmSAcdDw4ggAtAatlqw"
           target="_blank" rel="noopener"
           data-id="geo11-shab" data-title="Ø´Ø¨ Ø§Ù…ØªØ­Ø§Ù† â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²">
          <span class="badge"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg></span>
          <span class="title">Ø´Ø¨ Ø§Ù…ØªØ­Ø§Ù† â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²</span>
          <div class="actions">
            <div class="action-btn rate-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg></div>
            <div class="meta rate-avg"></div>
            <div class="action-btn cmt-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg></div>
            <div class="meta cmt-count"></div>
          </div>
        </a>
      </li>
    </ul>
  </section>

  <!-- Ø¯Ù‡Ù… -->
  <section class="panel">
    <h2>Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø¬ØºØ±Ø§ÙÛŒØ§ØŒ Ù¾Ø§ÛŒÙ‡ Ø¯Ù‡Ù…</h2>
    <ul class="books">
      <li>
        <a class="book-card" href="https://s32.picofile.com/file/8481978634/%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7_%D8%AF%D9%87%D9%85%D8%8C_%D8%B4%D8%A8_%D8%A7%D9%85%D8%AA%D8%AD%D8%A7%D9%86_B_U_L.pdf.html"
           target="_blank" rel="noopener"
           data-id="geo10-shab" data-title="Ø´Ø¨ Ø§Ù…ØªØ­Ø§Ù† â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²">
          <span class="badge"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg></span>
          <span class="title">Ø´Ø¨ Ø§Ù…ØªØ­Ø§Ù† â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²</span>
          <div class="actions">
            <div class="action-btn rate-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg></div>
            <div class="meta rate-avg"></div>
            <div class="action-btn cmt-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg></div>
            <div class="meta cmt-count"></div>
          </div>
        </a>
      </li>

      <li>
        <a class="book-card" href="https://s32.picofile.com/file/8481961634/%D8%AF%D8%B1%D8%B3%D9%86%D8%A7%D9%85%D9%87_%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7_%D8%AF%D9%87%D9%85_%D8%A8%D8%B1_%D8%B9%D9%85%D8%B1_%D9%84%D8%B9%D9%86%D8%AA.pdf.html"
           target="_blank" rel="noopener"
           data-id="geo10-dars" data-title="Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ Ø¬ØºØ±Ø§ÙÛŒØ§ â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²">
          <span class="badge"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg></span>
          <span class="title">Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ Ø¬ØºØ±Ø§ÙÛŒØ§ â€“ Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ø²</span>
          <div class="actions">
            <div class="action-btn rate-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg></div>
            <div class="meta rate-avg"></div>
            <div class="action-btn cmt-btn" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±Ø§Øª"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v18l4-4h14a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg></div>
            <div class="meta cmt-count"></div>
          </div>
        </a>
      </li>
    </ul>
  </section>

  <div style="text-align:center">
    <a class="btn-back" href="index.html">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</a>
  </div>

  <div id="counter"><span id="visit-count">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span></div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ -->
  <div class="modal" id="cmtModal">
    <div class="box">
      <h3 id="cmtTitle">Ù†Ø¸Ø±Ø§Øª</h3>

      <!-- Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…ØªÛŒØ§Ø² -->
      <div class="rate-row">
        <div class="rate-stars" id="rateStars">
          <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span>
          <span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <div id="rateLabel" class="meta"></div>
        <button class="btn" id="btnRate">Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²</button>
      </div>

      <ul class="cmt-list" id="cmtList"></ul>
      <textarea id="cmtInput" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>

      <div class="row">
        <button class="btn" id="sendCmt">Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø±</button>
        <button class="btn gray" id="closeCmt">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Firestore (Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, collection, query, where, orderBy,
      onSnapshot, getDoc, getDocs, addDoc, setDoc,
      serverTimestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Firebase Config (Ø§Ø² Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÛŒ Ø®ÙˆØ¯Øª)
    const firebaseConfig = {
      apiKey: "AIzaSyB6fWSRyXuMnJyCZz29hakPw2kkOD3JwqI",
      authDomain: "ketabha-58a96.firebaseapp.com",
      projectId: "ketabha-58a96",
      storageBucket: "ketabha-58a96.firebasestorage.app",
      messagingSenderId: "117717169254",
      appId: "1:117717169254:web:3c59186fa13432ba7529a7",
      measurementId: "G-SDF15BH8Z7"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡â€ŒÛŒ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ù…ØªÛŒØ§Ø²/Ù†Ø¸Ø± â€“ Ø§Ù„Ø²Ø§Ù…Ø§ Ù‡ÙˆÛŒØª ÙˆØ§Ù‚Ø¹ÛŒ Ù†ÛŒØ³Øª)
    const uid = (localStorage.getItem('uid') || (() => {
      const v = 'u_' + Math.random().toString(36).slice(2);
      localStorage.setItem('uid', v);
      return v;
    })());

    // ---- Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¨Ø§Ø²Ø¯ÛŒØ¯ (Ù…Ø«Ù„ Ù‚Ø¨Ù„ â€“ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø®ÙˆØ¯Øª)
    async function loadVisits(){
      const slug='geography';
      try{
        const r=await fetch(`/api/visits?slug=${encodeURIComponent(slug)}`,{cache:'no-store'});
        const d=await r.json();
        if(!r.ok||typeof d.value!=='number')throw 0;
        document.getElementById('visit-count').textContent=`Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø§ÛŒÙ† ØµÙØ­Ù‡: ${d.value}`;
        await fetch(`/api/log?slug=${encodeURIComponent(slug)}`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ua:navigator.userAgent})
        });
      }catch{
        document.getElementById('visit-count').textContent='Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡';
      }
    }
    loadVisits();

    // ---- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ Ø³ØªØ§Ø±Ù‡
    const rateStars = document.getElementById('rateStars');
    const rateLabel = document.getElementById('rateLabel');
    let   selectedRate = null;
    function setStars(n){
      [...rateStars.children].forEach((el,i)=> el.style.color=(i<n)?'#ffd04d':'#fff');
      rateLabel.textContent = n?`Ø§Ù…ØªÛŒØ§Ø² ${n} Ø§Ø² 5`:''; selectedRate=n||null;
    }
    rateStars.querySelectorAll('span').forEach(sp=> sp.addEventListener('click',()=> setStars(+sp.dataset.v)));

    // ---- Ù…ÙˆØ¯Ø§Ù„
    const modal       = document.getElementById('cmtModal');
    const cmtTitle    = document.getElementById('cmtTitle');
    const cmtList     = document.getElementById('cmtList');
    const cmtInput    = document.getElementById('cmtInput');
    const btnRate     = document.getElementById('btnRate');
    const btnSend     = document.getElementById('sendCmt');
    const btnClose    = document.getElementById('closeCmt');

    let currentBook   = null;
    let currentAvgEl  = null;
    let unSubComments = null;

    // ---- Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ Firestore (Realtime)
    const cards = document.querySelectorAll('.book-card');
    cards.forEach(card=>{
      const id          = card.dataset.id;
      const rateAvgEl   = card.querySelector('.rate-avg');
      const cmtCountEl  = card.querySelector('.cmt-count');
      const rateBtn     = card.querySelector('.rate-btn');
      const cmtBtn      = card.querySelector('.cmt-btn');

      // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² realtime Ø§Ø² Ø®ÙˆØ¯ Ø¯Ø§Ú©ÛŒÙˆÙ…Ù†Øª book
      onSnapshot(doc(db,'books',id),(snap)=>{
        const d = snap.data();
        const avg = (d && d.ratingCount>0) ? (d.ratingSum/d.ratingCount).toFixed(1) : '';
        rateAvgEl.textContent = avg;
      });

      // ØªØ¹Ø¯Ø§Ø¯ Ù†Ø¸Ø±Ø§Øª realtime
      const q = query(collection(db,'books',id,'comments'), orderBy('createdAt','desc'));
      onSnapshot(q, (ss) => {
        cmtCountEl.textContent = ss.size? ss.size : '';
        // Ø§Ú¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ú©ØªØ§Ø¨ Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯ØŒ Ù„ÛŒØ³Øª Ø±Ø§ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
        if (currentBook===id) renderComments(ss);
      });

      function open(){ openModal(id, card.dataset.title, rateAvgEl); }
      rateBtn.addEventListener('click', (e)=>{e.preventDefault();e.stopPropagation();open()});
      cmtBtn.addEventListener('click', (e)=>{e.preventDefault();e.stopPropagation();open()});
    });

    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ + Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ù…ØªÛŒØ§Ø²/Ù†Ø¸Ø±Ø§Øª Ú©ØªØ§Ø¨ Ø¬Ø§Ø±ÛŒ
    async function openModal(bookId, title, avgEl){
      currentBook  = bookId;
      currentAvgEl = avgEl;
      cmtTitle.textContent = 'Ù†Ø¸Ø±Ø§Øª Â«' + title + 'Â»';
      cmtInput.value = '';
      modal.style.display='flex';

      // Ù…Ù‚Ø¯Ø§Ø± Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø±
      const rDoc = await getDoc(doc(db,'books',bookId,'ratings',uid));
      setStars(rDoc.exists()? (rDoc.data().value||0) : 0);

      // Ù„ÛŒØ³Øª Ù†Ø¸Ø±Ø§Øª Ø¨ØµÙˆØ±Øª realtime
      if (unSubComments) unSubComments();
      const q = query(collection(db,'books',bookId,'comments'), orderBy('createdAt','desc'));
      unSubComments = onSnapshot(q, (ss)=> renderComments(ss));
    }

    function renderComments(snapshot){
      cmtList.innerHTML='';
      snapshot.forEach(docSnap=>{
        const li=document.createElement('li');
        li.textContent = docSnap.data().text || '';
        cmtList.appendChild(li);
      });
    }

    // Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² (Ø¨Ø§ transaction â€“ ØªØºÛŒÛŒØ± Ù‡Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    btnRate.addEventListener('click', async ()=>{
      if (!currentBook || !selectedRate) return;
      const bookRef   = doc(db,'books',currentBook);
      const userRef   = doc(bookRef,'ratings',uid);

      await runTransaction(db, async (t) => {
        const bookSnap = await t.get(bookRef);
        const userSnap = await t.get(userRef);

        let sum   = (bookSnap.exists() ? (bookSnap.data().ratingSum||0)   : 0);
        let count = (bookSnap.exists() ? (bookSnap.data().ratingCount||0) : 0);

        if (userSnap.exists()){
          const prev = userSnap.data().value || 0;
          sum += (selectedRate - prev);
          t.update(userRef, { value: selectedRate, updatedAt: serverTimestamp() });
        } else {
          count += 1;
          sum   += selectedRate;
          t.set(userRef,  { value: selectedRate, createdAt: serverTimestamp() });
        }
        t.set(bookRef, { ratingSum: sum, ratingCount: count }, { merge:true });
      });

      alert('Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯');
      // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¨Ù‡ ØµÙˆØ±Øª realtime Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øª Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯
    });

    // Ø«Ø¨Øª Ù†Ø¸Ø± (Ø¨Ø§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø­Ø¯Ø§Ú©Ø«Ø± Û² Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±/Ú©ØªØ§Ø¨ â€“ Ø±ÙˆÛŒ Firestore Ú†Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    btnSend.addEventListener('click', async ()=>{
      const txt = (cmtInput.value || '').trim();
      if(!txt || !currentBook) return;

      const cRef = collection(db,'books',currentBook,'comments');
      const q    = query(cRef, where('uid','==',uid));
      const res  = await getDocs(q);
      if (res.size >= 2){
        alert('Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©ØªØ§Ø¨ Ø­Ø¯Ø§Ú©Ø«Ø± 2 Ù†Ø¸Ø± Ù…Ø¬Ø§Ø² Ø§Ø³Øª.');
        return;
      }

      await addDoc(cRef, {
        text: txt,
        uid,
        createdAt: serverTimestamp()
      });
      cmtInput.value='';
      // onSnapshot Ø®ÙˆØ¯Ø´ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù„ÛŒØ³Øª Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    });

    btnClose.addEventListener('click',()=> modal.style.display='none');
    modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none' });
  </script>
</body>
</html>
