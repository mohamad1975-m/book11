<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>جغرافیا</title>
<style>
  @font-face{
    font-family:'iranyekanX';
    src:url('IRANYekanX-Light.woff2') format('woff2');
  }
  *{box-sizing:border-box}
  body{
    font-family:'iranyekanX',sans-serif;margin:0;padding:0;color:#fff;
    background:radial-gradient(circle at 20% 20%,#e3f2fd,transparent 40%),
               radial-gradient(circle at 80% 25%,#d4fc79,transparent 42%),
               radial-gradient(circle at 10% 70%,#fbc2eb,transparent 45%),
               radial-gradient(circle at 85% 78%,#cfd9df,transparent 45%),
               linear-gradient(180deg,#58a 0%,#2c3e50 100%);
    background-attachment:fixed;min-height:100vh;position:relative;
  }
  body::before{content:"";position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.25),transparent 30% 70%,rgba(0,0,0,.25)),radial-gradient(1200px 600px at 50% -10%,rgba(255,255,255,.12),transparent),linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.25));pointer-events:none;z-index:0}
  header{
    text-align:center;font-weight:800;margin:26px 0 10px;font-size:38px;
    background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#fbbf24,#f87171);
    background-size:400% 400%;
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    animation:headGrad 18s ease infinite;text-shadow:0 0 10px rgba(255,255,255,.25);position:relative;z-index:1
  }
  @keyframes headGrad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  /* toolbar */
  .toolbar{width:min(1100px,94%);margin:8px auto 14px;display:grid;grid-template-columns:1fr 1fr auto;gap:10px;position:relative;z-index:1}
  .search{display:flex;align-items:center;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(8px);padding:10px 12px;border-radius:14px}
  .search input{flex:1;border:none;background:transparent;color:#fff;font-size:14px;outline:none}
  .sort-btn{border:none;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);padding:10px 12px;border-radius:14px;color:#fff;cursor:pointer;backdrop-filter:blur(8px)}
  .sort-btn:hover{background:rgba(255,255,255,.18)}
  .modal-sort{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50;opacity:0;transition:opacity .15s ease}
  .modal-sort.show{display:flex;opacity:1}
  .modal-sort .box{min-width:min(560px,92%);background:rgba(30,41,59,.7);border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(10px);border-radius:16px;padding:14px}
  .modal-sort .sort-title{font-weight:800;margin-bottom:8px}
  .modal-sort .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btn{background:#3b82f6;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.gray{background:rgba(255,255,255,.15)}
  .btn:hover{filter:brightness(1.05)}

  /* books grid */
  .books{width:min(1100px,94%);margin:8px auto 60px;display:grid;grid-template-columns:repeat(2,1fr);gap:14px;position:relative;z-index:1}
  .books li{list-style:none}
  .book-card{display:grid;grid-template-columns:120px 1fr 70px;gap:10px;align-items:stretch;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.2);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 10px 25px rgba(0,0,0,.35);overflow:hidden;cursor:pointer}
  .thumb{background:linear-gradient(180deg,rgba(255,255,255,.25),rgba(255,255,255,.05));border-inline-end:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:90%;max-height:90%;filter:drop-shadow(0 10px 18px rgba(0,0,0,.35))}
  .content{padding:10px 6px 8px 0}
  .title{font-weight:800;margin-bottom:4px}
  .meta{opacity:.9;font-size:13px;display:flex;gap:8px;flex-wrap:wrap}
  .left-acts{display:grid;grid-template-columns:1fr;grid-auto-rows:minmax(38px,auto);align-content:center;justify-items:center;background:rgba(255,255,255,.06);border-inline-start:1px solid rgba(255,255,255,.18)}
  .icon-wrap{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .icon-wrap:hover{background:rgba(255,255,255,.18)}
  .under-txt{font-size:12px;opacity:.9}

  /* preview modal */
  #previewModal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60;opacity:0;transition:opacity .15s ease}
  #previewModal.show{display:flex;opacity:1}
  #pvBox{min-width:min(640px,94%);background:rgba(30,41,59,.78);border:1px solid rgba(255,255,255,.22);border-radius:16px;padding:14px;backdrop-filter:blur(10px)}
  #pvHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  #pvTitle{font-weight:800}
  #pvBody{font-size:14px;opacity:.95;line-height:1.8}
  #pvClose{border:none;width:32px;height:32px;border-radius:10px;background:rgba(255,255,255,.14);color:#fff;cursor:pointer}

  /* visits counter */
  .visit-badge{position:fixed;left:16px;bottom:16px;z-index:40;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:8px 12px;backdrop-filter:blur(6px);font-size:12.5px}

  /* --- Favorites (heart) positioning & states --- */
  .left-acts .fav{ grid-column:1; grid-row:5; }
  .left-acts .fav-label{ grid-column:1; grid-row:6; }
  .icon-wrap.fav.active{ background: rgba(255,255,255,.2); box-shadow: 0 8px 20px rgba(0,0,0,.45); }
  .icon-wrap.fav .heart-filled{ display:none }
  .icon-wrap.fav.active .heart-filled{ display:block }
  .icon-wrap.fav.active .heart-outline{ display:none }

  /* --- Tag chip in preview --- */
  .tag-chip{ display:inline-block; margin:3px; padding:4px 8px; border-radius:999px;
    background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); font-size:12px }
</style>
</head>
<body>

<header>کتاب‌های جغرافیا</header>

<div class="toolbar">
  <div class="search">
    <svg width="20" height="20" viewBox="0 0 24 24" style="margin-inline-end:8px;opacity:.9"><path fill="white" d="M10 2a8 8 0 105.293 14.293l4.707 4.707 1.414-1.414-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12A6 6 0 0110 4z"/></svg>
    <input id="searchInput" placeholder="جستجو در عنوان کتاب…" />
  </div>
  <button id="btnSort" class="sort-btn">مرتب‌سازی</button>
  <!-- دکمهٔ «برچسب» در جاوااسکریپت اضافه می‌شود -->
</div>

<!-- پنجرهٔ مرتب‌سازی (اصلی پروژه) -->
<div id="sortModal" class="modal-sort">
  <div class="box">
    <div class="sort-title">مرتب‌سازی</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" data-sort="title">بر اساس عنوان</button>
      <button class="btn gray" data-sort="size">بر اساس حجم</button>
      <button class="btn gray" data-sort="rate">بر اساس امتیاز</button>
    </div>
    <div class="row">
      <button id="sortClose" class="btn gray">بستن</button>
    </div>
  </div>
</div>

<!-- پنجرهٔ پیش‌نمایش -->
<div id="previewModal">
  <div id="pvBox">
    <div id="pvHead">
      <div id="pvTitle">پیش‌نمایش</div>
      <button id="pvClose">×</button>
    </div>
    <div id="pvBody"></div>
  </div>
</div>

<ul class="books">
  <!-- کارت‌ها: اطمینان از همان ساختار اصلی پروژه -->
  <li data-id="geo11-test">
    <div class="book-card" data-href="https://dl.example.com/geo11-test.pdf">
      <div class="thumb"><img src="covers/geo11-test.png" alt="یازدهم - تست"/></div>
      <div class="content">
        <div class="title">جغرافیا ۲ یازدهم – تست + درسنامه <span style="opacity:.7;font-weight:400;font-size:12px">(دانلود)</span></div>
        <div class="meta">
          <span>پایه یازدهم</span><span>PDF</span><span>آپدیت</span>
        </div>
      </div>
      <div class="left-acts">
        <!-- دانلود -->
        <div class="icon-wrap download" title="دانلود">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M5 20h14v-2H5v2zM11 2h2v10h3l-4 4-4-4h3V2z"/></svg>
        </div>
        <div class="under-txt dl-label">۰</div>

        <!-- اشتراک‌گذاری -->
        <div class="icon-wrap share" title="اشتراک‌گذاری">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.27 3.27 0 000-1.39l7-4.11A3 3 0 0018 7a3 3 0 10-2.83-2H15v.17l-7 4.09A3 3 0 006 9a3 3 0 100 6c.76 0 1.44-.3 1.96-.77l7.13 4.15c-.05.2-.09.4-.09.62a3 3 0 103-2.92z"/></svg>
        </div>
        <!-- برچسب عدد اشتراک‌گذاری اینجا با JS اضافه می‌شود -->

        <!-- خرید -->
        <div class="icon-wrap buy" title="خرید از دیجی‌کالا">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 1.99-.9 1.99-2S18.1 18 17 18zM7.2 14l.03.01L17 14c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0021.5 5H6.21l-.94-2H1v2h3l3.6 7.59-1.35 2.45A2 2 0 006 18h12v-2H7.42a.25.25 0 01-.22-.37L7.2 14z"/></svg>
        </div>
        <!-- برچسب عدد خرید اینجا با JS اضافه می‌شود -->
      </div>
    </div>
  </li>

  <li data-id="geo11-shab">
    <div class="book-card" data-href="https://dl.example.com/geo11-shab.pdf">
      <div class="thumb"><img src="covers/geo11-shab.png" alt="یازدهم - شب امتحان"/></div>
      <div class="content">
        <div class="title">شب امتحان – پایه یازدهم <span style="opacity:.7;font-weight:400;font-size:12px">(دانلود)</span></div>
        <div class="meta"><span>پایه یازدهم</span><span>PDF</span></div>
      </div>
      <div class="left-acts">
        <div class="icon-wrap download" title="دانلود">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M5 20h14v-2H5v2zM11 2h2v10h3l-4 4-4-4h3V2z"/></svg>
        </div>
        <div class="under-txt dl-label">۰</div>

        <div class="icon-wrap share" title="اشتراک‌گذاری">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.27 3.27 0 000-1.39l7-4.11A3 3 0 0018 7a3 3 0 10-2.83-2H15v.17l-7 4.09A3 3 0 006 9a3 3 0 100 6c.76 0 1.44-.3 1.96-.77l7.13 4.15c-.05.2-.09.4-.09.62a3 3 0 103-2.92z"/></svg>
        </div>

        <div class="icon-wrap buy" title="خرید از دیجی‌کالا">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 1.99-.9 1.99-2S18.1 18 17 18zM7.2 14l.03.01L17 14c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0021.5 5H6.21l-.94-2H1v2h3l3.6 7.59-1.35 2.45A2 2 0 006 18h12v-2H7.42a.25.25 0 01-.22-.37L7.2 14z"/></svg>
        </div>
      </div>
    </div>
  </li>

  <li data-id="geo10-shab">
    <div class="book-card" data-href="https://dl.example.com/geo10-shab.pdf">
      <div class="thumb"><img src="covers/geo10-shab.png" alt="دهم - شب امتحان"/></div>
      <div class="content">
        <div class="title">شب امتحان – پایه دهم <span style="opacity:.7;font-weight:400;font-size:12px">(دانلود)</span></div>
        <div class="meta"><span>پایه دهم</span><span>PDF</span></div>
      </div>
      <div class="left-acts">
        <div class="icon-wrap download" title="دانلود">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M5 20h14v-2H5v2zM11 2h2v10h3l-4 4-4-4h3V2z"/></svg>
        </div>
        <div class="under-txt dl-label">۰</div>

        <div class="icon-wrap share" title="اشتراک‌گذاری">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.27 3.27 0 000-1.39l7-4.11A3 3 0 0018 7a3 3 0 10-2.83-2H15v.17l-7 4.09A3 3 0 006 9a3 3 0 100 6c.76 0 1.44-.3 1.96-.77l7.13 4.15c-.05.2-.09.4-.09.62a3 3 0 103-2.92z"/></svg>
        </div>

        <div class="icon-wrap buy" title="خرید از دیجی‌کالا">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 1.99-.9 1.99-2S18.1 18 17 18zM7.2 14l.03.01L17 14c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0021.5 5H6.21l-.94-2H1v2h3l3.6 7.59-1.35 2.45A2 2 0 006 18h12v-2H7.42a.25.25 0 01-.22-.37L7.2 14z"/></svg>
        </div>
      </div>
    </div>
  </li>

  <li data-id="geo10-dars">
    <div class="book-card" data-href="https://dl.example.com/geo10-dars.pdf">
      <div class="thumb"><img src="covers/geo10-dars.png" alt="دهم - درسنامه"/></div>
      <div class="content">
        <div class="title">درسنامه – پایه دهم <span style="opacity:.7;font-weight:400;font-size:12px">(دانلود)</span></div>
        <div class="meta"><span>پایه دهم</span><span>PDF</span></div>
      </div>
      <div class="left-acts">
        <div class="icon-wrap download" title="دانلود">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M5 20h14v-2H5v2zM11 2h2v10h3l-4 4-4-4h3V2z"/></svg>
        </div>
        <div class="under-txt dl-label">০</div>

        <div class="icon-wrap share" title="اشتراک‌گذاری">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.27 3.27 0 000-1.39l7-4.11A3 3 0 0018 7a3 3 0 10-2.83-2H15v.17l-7 4.09A3 3 0 006 9a3 3 0 100 6c.76 0 1.44-.3 1.96-.77l7.13 4.15c-.05.2-.09.4-.09.62a3 3 0 103-2.92z"/></svg>
        </div>

        <div class="icon-wrap buy" title="خرید از دیجی‌کالا">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="white" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 1.99-.9 1.99-2S18.1 18 17 18zM7.2 14l.03.01L17 14c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0021.5 5H6.21l-.94-2H1v2h3ل3.6 7.59-1.35 2.45A2 2 0 006 18h12v-2H7.42a.25.25 0 01-.22-.37L7.2 14z"/></svg>
        </div>
      </div>
    </div>
  </li>
</ul>

<div class="visit-badge">بازدید این صفحه: <span id="visit-count">—</span></div>

<script>
// شمارندهٔ بازدید (مثل قبل)
(async function(){
  try{
    const r=await fetch('/api/visits?page=geography',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ua:navigator.userAgent})});
    const d=await r.json();
    document.getElementById('visit-count').textContent=(d?.count??0).toLocaleString('fa-IR');
  }catch{
    document.getElementById('visit-count').textContent='خطا در دریافت شمارنده';
  }
})();
</script>

<script>
// داده‌های ثابت هر کتاب
const bookMeta={
  'geo11-test':{size:'88 MB',rate:null,votes:null,buy:'https://www.digikala.com/product/dkp-5746151/کتاب-جغرافیا-2-پایه-یازدهم-رشته-انسانی-اثر-زهرا-نعمتی-و-الهه-همایون-زاده-انتشارات-خیلی-سبز/', publisher:'خیلی سبز', tags:['تست','درسنامه','خیلی‌سبز']},
  'geo11-shab':{size:'23 MB',rate:4.4,votes:26,buy:'https://www.digikala.com/product/dkp-820916/کتاب-شب-امتحان-جغرافیا-پایه-یازدهم-اثر-سیده-مریم-طاهری/', publisher:'خیلی سبز', tags:['شب‌امتحان','خیلی‌سبز']},
  'geo10-shab':{size:'24 MB',rate:4.5,votes:67,buy:'https://www.digikala.com/product/dkp-4123378/کتاب-شب-امتحان-جغرافیا-ایران-دهم-اثر-مهدی-کاردان-و-شادی-کاریان-انتشارات-خیلی-سبز/', publisher:'خیلی سبز', tags:['شب‌امتحان','خیلی‌سبز']},
  'geo10-dars':{size:'36 MB',rate:4.2,votes:45,buy:'https://www.digikala.com/product/dkp-16924367/کتاب-پرسش-های-چهارگزینه-ای-جغرافیا-جامع-اثر-دکتر-زهرا-نعمتی-و-دکتر-حمیدرضا-بهیاد-انتشارات-خیلی-سبز/', publisher:'خیلی سبز', tags:['درسنامه','خیلی‌سبز']},
};
</script>

<script>
// جستجو و مرتب‌سازی (نسخه اصلی پروژه)
(function(){
  const input=document.getElementById('searchInput');
  input.addEventListener('input',()=>{
    const q=input.value.trim();
    document.querySelectorAll('.books li').forEach(li=>{
      const t=li.querySelector('.title').textContent;
      li.style.display= t.includes(q) ? '' : 'none';
    });
  });
  const btnSort=document.getElementById('btnSort');
  const sortModal=document.getElementById('sortModal');
  const sortClose=document.getElementById('sortClose');
  btnSort.addEventListener('click',()=>{sortModal.style.display='flex';setTimeout(()=>sortModal.classList.add('show'),10)});
  sortClose.addEventListener('click',()=>{sortModal.classList.remove('show');setTimeout(()=>sortModal.style.display='none',150)});
})();
</script>

<script>
// مودال پیش‌نمایش (نسخهٔ اصلی پروژه)
const pvModal=document.getElementById('previewModal');
const pvClose=document.getElementById('pvClose');
function openPreview(card,id){
  // نسخه اصلی چیزی می‌گذارد؛ ما پایین‌تر override می‌کنیم
  pvModal.style.display='flex'; setTimeout(()=>pvModal.classList.add('show'),10);
}
pvClose.addEventListener('click',()=>{pvModal.classList.remove('show');setTimeout(()=>pvModal.style.display='none',150)});
</script>

<!-- ========= افزونه‌ها: علاقه‌مندی + برچسب‌ها + اشتراک‌گذاری حرفه‌ای ========= -->
<script>
(function(){
  const deviceId = (localStorage.getItem('device_id') || (()=>{const v='dvc_'+Math.random().toString(36).slice(2);localStorage.setItem('device_id',v);return v})());

  const FAVS_KEY='my_favs';
  function getMyFavs(){ try{return JSON.parse(localStorage.getItem(FAVS_KEY))||[]}catch{return []} }
  function setMyFavs(v){ localStorage.setItem(FAVS_KEY, JSON.stringify(v)) }
  function isMyFav(id){ return getMyFavs().includes(id) }
  function addMyFav(id){ const s=new Set(getMyFavs()); s.add(id); setMyFavs([...s]) }
  function removeMyFav(id){ const s=new Set(getMyFavs()); s.delete(id); setMyFavs([...s]) }

  async function favGet(book){
    const r = await fetch(`/api/favorites?book=${encodeURIComponent(book)}&device=${encodeURIComponent(deviceId)}`, { cache:'no-store' });
    const d = await r.json(); return { count: d?.count ?? 0, isFav: !!d?.isFav };
  }
  async function favToggle(book, toAdd){
    const r = await fetch('/api/favorites', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ book, device: deviceId, op: toAdd?'add':'remove' }) });
    const d = await r.json();
    if(!r.ok) throw new Error(d?.error||'fav error');
    return { count: d?.count ?? 0, isFav: !!d?.isFav };
  }

  // دکمهٔ «برچسب» کنار مرتب‌سازی
  const toolbar = document.querySelector('.toolbar');
  if(toolbar && !document.getElementById('btnTags')){
    const btn = document.createElement('button');
    btn.id='btnTags'; btn.className='sort-btn'; btn.textContent='برچسب';
    toolbar.appendChild(btn);
  }

  // پنجرهٔ فیلتر برچسب
  if(!document.getElementById('tagsModal')){
    const modal = document.createElement('div');
    modal.className='modal-sort'; modal.id='tagsModal'; modal.innerHTML = `
      <div class="box">
        <div class="sort-title">فیلتر بر اساس برچسب‌ها</div>
        <div id="tagsContainer" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        <div class="row">
          <button class="btn gray" id="btnTagsClear">پاک کردن</button>
          <button class="btn" id="btnTagsApply">اعمال</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }

  const btnTags = document.getElementById('btnTags');
  const tagsModal = document.getElementById('tagsModal');
  const tagsContainer = document.getElementById('tagsContainer');
  const btnTagsClear = document.getElementById('btnTagsClear');
  const btnTagsApply = document.getElementById('btnTagsApply');
  let selectedTags = new Set();

  function openTags(){ buildTagsList(); tagsModal.style.display='flex'; setTimeout(()=>tagsModal.classList.add('show'),10) }
  function closeTags(){ tagsModal.classList.remove('show'); setTimeout(()=>tagsModal.style.display='none',160) }
  btnTags && btnTags.addEventListener('click', openTags);
  tagsModal && tagsModal.addEventListener('click', e=>{ if(e.target===tagsModal) closeTags() });

  function buildTagsList(){
    const all = new Set();
    Object.values(bookMeta).forEach(m => (m.tags||[]).forEach(t=>all.add(t)));
    const list = [...all].sort((a,b)=> a.localeCompare(b,'fa'));
    tagsContainer.innerHTML = list.map(t=>`
      <label style="display:inline-flex;align-items:center;gap:6px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; cursor:pointer">
        <input type="checkbox" value="${t}" ${selectedTags.has(t)?'checked':''} />
        <span>${t}</span>
      </label>
    `).join('');
  }
  btnTagsClear && btnTagsClear.addEventListener('click', ()=>{ selectedTags.clear(); buildTagsList(); });
  btnTagsApply && btnTagsApply.addEventListener('click', ()=>{
    selectedTags = new Set([...tagsContainer.querySelectorAll('input[type=checkbox]:checked')].map(i=>i.value));
    applyTagFilter(); closeTags();
  });

  function applyTagFilter(){
    const active = [...selectedTags];
    document.querySelectorAll('.books li').forEach(li=>{
      const id=li.dataset.id, meta=bookMeta[id]||{};
      const tags = meta.tags || [];
      const ok = active.length===0 ? true : active.every(t=>tags.includes(t));
      li.style.display = ok ? '' : 'none';
    });
  }

  // تقویت کارت‌ها: قلب علاقه‌مندی + اشتراک‌گذاری حرفه‌ای
  function enhanceCards(){
    document.querySelectorAll('.book-card').forEach(card=>{
      const li=card.closest('li'); const id=li.dataset.id;
      const left=card.querySelector('.left-acts');

      // قلب + برچسب تعداد
      if(left && !left.querySelector('.icon-wrap.fav')){
        const favBtn = document.createElement('div');
        favBtn.className='icon-wrap fav'; favBtn.title='علاقه‌مندی';
        favBtn.innerHTML = '<svg class="heart-outline" viewBox="0 0 24 24"><path d="M12.1 8.64l-.1.1-.11-.11C10.14 6.9 7.1 7 5.5 8.6c-1.67 1.67-1.67 4.38 0 6.05l6.3 6.3 6.3-6.3c1.67-1.67 1.67-4.38 0-6.05-1.6-1.6-4.64-1.7-6.3.04z" fill="none" stroke="white" stroke-width="1.6"/></svg><svg class="heart-filled" viewBox="0 0 24 24"><path d="M12.1 21.35l-1.1-1.01C5.14 15.28 2 12.36 2 8.99 2 6.42 4.42 4 7 4c1.54 0 3.04.73 4 1.87C11.96 4.73 13.46 4 15 4c2.58 0 5 2.42 5 4.99 0 3.37-3.14 6.29-8.9 11.35z"/></svg>';
        left.appendChild(favBtn);
        const favLbl = document.createElement('div');
        favLbl.className='under-txt fav-label'; favLbl.setAttribute('data-favcount',''); favLbl.textContent='۰';
        left.appendChild(favLbl);

        favGet(id).then(({count,isFav})=>{
          favLbl.textContent = (count||0).toLocaleString('fa-IR');
          const myFav = isMyFav(id);
          if(isFav && !myFav) addMyFav(id);
          if(!isFav && myFav) removeMyFav(id);
          favBtn.classList.toggle('active', isMyFav(id));
        }).catch(()=>{});

        favBtn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          const willAdd = !favBtn.classList.contains('active');
          favBtn.style.transform='translateY(-2px)'; setTimeout(()=>favBtn.style.transform='',130);
          try{
            const {count,isFav} = await favToggle(id, willAdd);
            favLbl.textContent = (count||0).toLocaleString('fa-IR');
            favBtn.classList.toggle('active', isFav);
            if(isFav) addMyFav(id); else removeMyFav(id);
          }catch{}
        });
      }

      // اشتراک‌گذاری حرفه‌ای
      const shareEl = card.querySelector('.icon-wrap.share');
      if(shareEl && !shareEl._enhanced){
        shareEl.addEventListener('click', async (e)=>{
          e.preventDefault();
          const title = card.querySelector('.title').firstChild.textContent.trim();
          const href  = card.dataset.href;
          const meta  = bookMeta[id]||{};
          const pub = meta.publisher ? `ناشر: ${meta.publisher}\n` : '';
          const rating = (meta.rate==null)? '' : `امتیاز: ${meta.rate}${meta.votes?` از ${meta.votes} رأی`:''}\n`;
          const buy = meta.buy ? `خرید: ${meta.buy}\n` : '';
          const download = href ? `دانلود PDF: ${href}\n` : '';
          const more = `\nبرای مشاهده‌ی کتاب‌های بیشتر روی لینک زیر کلیک کنید:\nhttps://book11-one.vercel.app/`;
          const text = `«${title}»\n${pub}${rating}${buy}${download}${more}`;
          if(navigator.share){ try{ await navigator.share({title, text}); }catch{} }
          else{ try{ await navigator.clipboard.writeText(text); alert('متن اشتراک‌گذاری کپی شد'); }catch{ alert('کپی نشد؛ دستی کپی کنید.') } }
        }, true);
        shareEl._enhanced = true;
      }
    });
  }

  // اوورراید پیش‌نمایش برای نمایش برچسب‌ها/ناشر/لینک‌ها
  const originalOpenPreview = window.openPreview;
  window.openPreview = function(card, id){
    const meta = bookMeta[id]||{};
    const title = card.querySelector('.title').textContent.replace(/\(\d+ دانلود\)/,'').trim();
    const href  = card.dataset.href;
    const tagsHtml = (meta.tags && meta.tags.length)
      ? meta.tags.map(t=>`<span class="tag-chip">${t}</span>`).join('')
      : '<span style="opacity:.8">—</span>';
    document.getElementById('pvTitle').textContent='پیش‌نمایش «'+title+'»';
    document.getElementById('pvBody').innerHTML =
      `<div>ناشر: <b>${meta.publisher||'—'}</b></div>
       <div>حجم فایل: <b>${meta.size||'نامشخص'}</b></div>
       <div>برچسب‌ها: ${tagsHtml}</div>
       <div>لینک دانلود: ${href?`<a href="${href}" target="_blank" rel="noopener" style="color:#aef">باز کردن</a>`:'نامشخص'}</div>
       <div>امتیاز دیجی‌کالا: <b>${meta.rate==null?'ناموجود':meta.rate}</b> ${meta.votes?`(از ${meta.votes} رأی)`:''}</div>
       <div style="margin-top:6px">خرید: ${meta.buy?`<a href="${meta.buy}" target="_blank" rel="noopener" style="color:#aef">مشاهده در دیجی‌کالا</a>`:'—'}</div>`;
    const pvModal=document.getElementById('previewModal'); pvModal.style.display='flex'; setTimeout(()=>pvModal.classList.add('show'),10);
  }

  enhanceCards();
  setTimeout(enhanceCards, 500);
})();
</script>

<!-- ========= شمارندهٔ «اشتراک‌گذاری» و «خرید» ========= -->
<script>
(function(){
  async function counterGet(type, book){
    const r = await fetch(`/api/counters?type=${encodeURIComponent(type)}&book=${encodeURIComponent(book)}`, {cache:'no-store'});
    const d = await r.json(); return (typeof d.value==='number') ? d.value : 0;
  }
  async function counterInc(type, book, inc=1){
    try{
      const r = await fetch('/api/counters', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type, book, inc })
      });
      const d = await r.json();
      return (typeof d.value==='number') ? d.value : null;
    }catch{ return null; }
  }

  function ensureLabel(iconEl, cls){
    let el = iconEl.parentElement.querySelector('.under-txt.'+cls);
    if(!el){
      el = document.createElement('div');
      el.className = 'under-txt ' + cls;
      el.textContent = '۰';
      iconEl.parentElement.appendChild(el);
    }
    return el;
  }

  document.querySelectorAll('.book-card').forEach(card=>{
    const li = card.closest('li'); const id = li?.dataset?.id;
    if(!id) return;
    const meta = window.bookMeta ? (window.bookMeta[id] || {}) : {};

    // SHARE
    const shareEl = card.querySelector('.icon-wrap.share');
    if(shareEl && !shareEl._wiredCounters){
      const shareLbl = ensureLabel(shareEl, 'share-label');
      counterGet('shares', id).then(v=> shareLbl.textContent = (v||0).toLocaleString('fa-IR')).catch(()=>{});
      shareEl.addEventListener('click', async ()=>{
        const cur = parseInt((shareLbl.textContent||'0').replace(/[^\d]/g,'')) || 0;
        shareLbl.textContent = (cur+1).toLocaleString('fa-IR');
        const nv = await counterInc('shares', id, 1);
        if(typeof nv==='number') shareLbl.textContent = nv.toLocaleString('fa-IR');
      });
      shareEl._wiredCounters = true;
    }

    // BUY
    const buyEl = card.querySelector('.icon-wrap.buy');
    if(buyEl && !buyEl._wiredCounters){
      const buyLbl = ensureLabel(buyEl, 'buy-label');
      counterGet('buys', id).then(v=> buyLbl.textContent = (v||0).toLocaleString('fa-IR')).catch(()=>{});
      buyEl.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        if(!meta.buy){ return; }
        window.open(meta.buy, '_blank', 'noopener');
        const cur = parseInt((buyLbl.textContent||'0').replace(/[^\d]/g,'')) || 0;
        buyLbl.textContent = (cur+1).toLocaleString('fa-IR');
        counterInc('buys', id, 1);
      });
      buyEl._wiredCounters = true;
    }
  });
})();
</script>

<!-- === Salawat Global Counter (Fixed Alignment) === -->
<div id="gc-widget" style="
  position:fixed; right:16px; bottom:16px; z-index:9999; direction:rtl; font-family:inherit;
  transition: transform .18s ease, opacity .18s ease;
">
  <div style="
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 10px 25px rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    color:#fff; padding:10px 12px; border-radius:14px; min-width:230px;
  ">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px">
      <div style="font-weight:800; font-size:14.5px; text-shadow:0 2px 6px rgba(0,0,0,.45)">
        صلوات‌شمار
      </div>
      <button id="gc-close" aria-label="بستن" title="بستن" style="
        width:26px; height:26px; border:none; border-radius:8px; cursor:pointer; color:#fff;
        background:rgba(255,255,255,.18); box-shadow:0 3px 10px rgba(0,0,0,.3);
        display:flex; align-items:center; justify-content:center; font-weight:900;
        transition: transform .14s ease, background .14s ease;
      ">×</button>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <div style="opacity:.95; font-size:13.5px">
        مجموع: <b id="gc-value">—</b>
      </div>
      <button id="gc-inc" style="
        border:none; cursor:pointer; color:#fff;
        background: linear-gradient(135deg,#34d399,#10b981);
        box-shadow: 0 6px 16px rgba(0,0,0,.35);
        border-radius:10px; padding:8px 12px; font-family:inherit;
        transition: transform .12s ease;
      ">+ اضافه</button>
    </div>
  </div>
</div>

<div id="gc-toast" style="
  position:fixed; left:50%; transform:translateX(-50%) translateY(20px);
  bottom:12px; z-index:10000; pointer-events:none;
  opacity:0; transition: opacity .25s ease, transform .25s ease;
">
  <div style="
    background: rgba(0,0,0,.6); color:#fff; padding:10px 14px; border-radius:10px;
    border:1px solid rgba(255,255,255,.2); box-shadow:0 8px 20px rgba(0,0,0,.35);
    font-size:13.5px; backdrop-filter: blur(4px); white-space:nowrap;
  " id="gc-toast-text"></div>
</div>

<script>
(function(){
  const w  = document.getElementById('gc-widget');
  const valEl = document.getElementById('gc-value');
  const btnInc = document.getElementById('gc-inc');
  const btnClose = document.getElementById('gc-close');
  const toast = document.getElementById('gc-toast');
  const toastText = document.getElementById('gc-toast-text');

  btnInc.addEventListener('pointerdown', ()=> btnInc.style.transform='scale(0.96)');
  btnInc.addEventListener('pointerup',   ()=> btnInc.style.transform='scale(1)');

  async function refresh(){
    try{
      const r = await fetch('/api/global-counter',{cache:'no-store'});
      const d = await r.json();
      if(!r.ok || typeof d.value!=='number') throw 0;
      valEl.textContent = d.value.toLocaleString('fa-IR');
    }catch{
      valEl.textContent = 'خطا';
    }
  }

  async function inc(){
    btnInc.disabled = true;
    try{
      const r = await fetch('/api/global-counter', { method:'POST' });
      const d = await r.json();
      if(!r.ok || typeof d.value!=='number') throw 0;
      valEl.textContent = d.value.toLocaleString('fa-IR');
    }catch{
      showToast('نتونستم افزایش بدم؛ دوباره تلاش کن.');
    }finally{
      btnInc.disabled = false;
    }
  }

  function showToast(msg){
    toastText.textContent = msg;
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) translateY(0)';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) translateY(20px)';
    }, 5000);
  }

  function closeWidget(){
    w.style.opacity = '0';
    w.style.transform = 'translateY(10px) scale(0.98)';
    setTimeout(()=>{ w.style.display='none'; }, 180);
    showToast('صلوات‌شمار بسته شد؛ برای برگشتن، صفحه را رفرش کنید.');
  }

  btnInc.addEventListener('click', inc);
  btnClose.addEventListener('click', closeWidget);

  refresh();
})();
</script>
<!-- === /Salawat Global Counter === -->

</body>
</html>
