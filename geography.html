<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>جغرافیا</title>
<style>
  @font-face{font-family:'iranyekan';src:url('iranyekanweblight.woff') format('woff')}
  *{box-sizing:border-box}
  body{
    font-family:'iranyekan',sans-serif;margin:0;padding:0;color:#fff;
    background:radial-gradient(circle at 20% 20%,#e3f2fd,transparent 40%),
               radial-gradient(circle at 80% 25%,#d4fc79,transparent 42%),
               radial-gradient(circle at 20% 80%,#96e6a1,transparent 45%),
               radial-gradient(circle at 80% 75%,#8fd3f4,transparent 40%),
               linear-gradient(180deg,#58a 0%,#2c3e50 100%);
    background-attachment:fixed;min-height:100vh;position:relative
  }
  body::before{content:"";position:fixed;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.15),rgba(0,0,0,.25));pointer-events:none;z-index:0}

  header{
    text-align:center;font-weight:800;margin:26px 0 10px;font-size:38px;
    background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#fbbf24,#f87171);
    background-size:400% 400%;
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    animation:headGrad 18s ease infinite;text-shadow:0 0 10px rgba(255,255,255,.25);position:relative;z-index:1
  }
  @keyframes headGrad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  .panel{
    width:min(920px,95%);margin:20px auto;padding:22px 20px 26px;background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.2);border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.35);
    backdrop-filter:blur(6px);position:relative;z-index:1
  }
  .panel h2{margin:0 0 18px;font-size:22px;color:#f1f5f9;text-shadow:0 2px 8px rgba(0,0,0,.4)}
  ul.books{list-style:none;margin:0;padding:0}
  li{margin:10px 0}

  /* --- کنترل‌های بالا --- */
  .top-controls{
    width:min(920px,95%);margin:8px auto 0;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap
  }
  .top-controls .box{
    position:relative;
    flex:1 1 240px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);
    border-radius:12px;padding:8px 10px;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.25);backdrop-filter:blur(6px)
  }
  .top-controls input{
    width:100%;border:none;background:transparent;color:#FFFFFF;font-family:'iranyekan';
    outline:none;font-size:14px
  }
  /* دکمه پاک‌کن در سرچ */
  .clear-x{
    position:absolute;left:8px;top:50%;transform:translateY(-50%);
    width:20px;height:20px;border-radius:50%;display:none;align-items:center;justify-content:center;
    cursor:pointer;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);color:#fff;font-size:14px
  }
  .box.has-val .clear-x{display:flex}

  .sort-opener{
    cursor:pointer;user-select:none;color:#fff
  }

  /* پنل شیشه‌ای مرتب‌سازی */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:80}
  .overlay .glass{
    width:min(400px,92%);padding:12px;border-radius:14px;background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.25);box-shadow:0 18px 40px rgba(0,0,0,.45);backdrop-filter:blur(8px);color:#fff
  }
  .glass h4{margin:0 0 10px;font-size:16px}
  .glass .opt{padding:10px;border-radius:10px;margin:8px 0;background:rgba(255,255,255,.1);cursor:pointer}
  .glass .opt:hover{background:rgba(255,255,255,.18)}

  /* --- کارت کتاب --- */
  .book-card{
    display:flex;align-items:center;justify-content:space-between;gap:10px;text-decoration:none;color:#fff;
    background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.15);padding:16px 18px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.28);transition:transform .18s ease,box-shadow .18s ease,background .18s ease;position:relative
  }
  .book-card:hover{transform:translateY(-3px);background:rgba(255,255,255,.16);box-shadow:0 12px 28px rgba(0,0,0,.45)}
  .title{font-size:16.5px;line-height:1.6;white-space:normal;word-wrap:break-word;flex:1;text-shadow:0 2px 6px rgba(0,0,0,.45)}
  .dlcount{font-size:12px;opacity:.95;margin-right:8px}

  /* ستون چپ: دو ردیف (دانلود+ستاره) و (اشتراک+خرید) + اندازه */
  .leftcol{
    display:flex;flex-direction:column;align-items:center;gap:6px;min-width:72px;margin-left:8px
  }
  .row-actions{display:flex;gap:8px}
  .badge{
    width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.45));transition:transform .15s ease
  }
  .badge:hover{transform:translateY(-2px)}
  .badge svg{width:100%;height:100%;fill:#fff}
  .size-lbl{font-size:11px;color:#eaeaea;text-shadow:0 2px 6px rgba(0,0,0,.45)}

  /* توست */
  .toast{position:fixed;left:50%;bottom:-120px;transform:translateX(-50%);z-index:90;background:rgba(0,0,0,.75);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 22px rgba(0,0,0,.4);font-size:13.5px;opacity:0;transition:all .35s ease}
  .toast.show{bottom:14px;opacity:1}
  .toast.hide{bottom:-140px;opacity:0}

  .btn-back{display:inline-block;margin:24px auto 10px;background:linear-gradient(135deg,#1C93E3,#2ea3f2);padding:12px 26px;color:#fff;text-decoration:none;border-radius:12px;box-shadow:0 8px 18px rgba(28,147,227,.4);transition:transform .15s ease, box-shadow .15s ease}
  .btn-back:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(28,147,227,.6)}

  #counter{text-align:center;margin:20px 0 30px;font-size:15px;color:#eaeaea;text-shadow:0 2px 6px rgba(0,0,0,.45)}

  /* مودال پیش‌نمایش (بدون تغییر) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60}
  .modal .box{width:min(820px,92%);border-radius:16px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);box-shadow:0 18px 40px rgba(0,0,0,.45);padding:14px 16px;backdrop-filter:blur(6px);color:#fff}
  .modal h3{margin:6px 0 12px;font-size:18px}
  .btn{border:none;border-radius:10px;padding:8px 16px;cursor:pointer;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.35);background:linear-gradient(135deg,#34d399,#10b981);font-family:'iranyekan'}
  .btn.gray{background:linear-gradient(135deg,#64748b,#475569)}
  .box iframe{width:100%;height:60vh;border:none;border-radius:12px;background:#fff}
</style>
</head>
<body>
  <header>جغرافیا 📘</header>

  <!-- کنترل‌ها -->
  <div class="top-controls">
    <div class="box" id="searchBoxWrap">
      <input id="searchBox" type="text" placeholder="جست‌وجو بین کتاب‌ها..." />
      <div class="clear-x" id="clearX">×</div>
    </div>
    <div class="box">
      <div class="sort-opener" id="sortOpener">مرتب‌سازی: پیش‌فرض</div>
    </div>
  </div>

  <!-- پنل مرتب‌سازی با بک‌گراند تار -->
  <div class="overlay" id="sortOverlay">
    <div class="glass">
      <h4>مرتب‌سازی بر اساس</h4>
      <div class="opt" data-mode="default">پیش‌فرض</div>
      <div class="opt" data-mode="score">بیشترین امتیاز</div>
      <div class="opt" data-mode="downloads">بیشترین دانلود</div>
      <div class="opt" data-mode="size">کم‌حجم‌ترین</div>
    </div>
  </div>

  <!-- یازدهم -->
  <section class="panel">
    <h2>کتاب‌های جغرافیا، پایه یازدهم</h2>
    <ul class="books" id="list11">
      <li>
        <div class="book-card"
             data-id="geo11-test"
             data-title="پرسش‌های چهارگزینه‌ای (به همراه درسنامه) – خیلی سبز"
             data-download="https://mega.nz/file/EygHRLaZ#XYM70813eKudH6DVdHsdduHbCb9I5d-W6NqhVDMngfs"
             data-size="88"
             data-buy="https://www.digikala.com/product/dkp-9512809/کتاب-پرسش-های-چهارگزینه-ای-جغرافیا-2-اثر-زهرا-نعمتی-و-الهه-همایون-زاده-انتشارات-خیلی-سبز/"
             data-score="?" data-scoretext="برای این کتاب در دیجی‌کالا امتیازی ثبت نشده است.">
          <!-- ستون چپ: بالا(دانلود+ستاره)، پایین(اشتراک+خرید) + حجم -->
          <div class="leftcol">
            <div class="row-actions">
              <a class="badge dl-btn" title="دانلود" target="_blank" rel="noopener">
                <!-- دانلود -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
              </a>
              <div class="badge star-btn" title="امتیاز دیجی‌کالا">
                <!-- ستاره -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
              </div>
            </div>
            <div class="row-actions">
              <div class="badge share-btn" title="اشتراک‌گذاری">
                <!-- اشتراک -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-0.76 0-1.44 0.3-1.96 0.77l-7.13-4.11c0.05-0.25 0.09-0.5 0.09-0.76s-0.04-0.51-0.09-0.76l7.09-4.1c0.54 0.5 1.25 0.81 2.04 0.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 0.26 0.04 0.51 0.09 0.76l-7.09 4.1c-0.54-0.5-1.25-0.81-2.04-0.81-1.66 0-3 1.34-3 3s1.34 3 3 3c0.79 0 1.5-0.31 2.04-0.81l7.13 4.11c-0.05 0.23-0.08 0.47-0.08 0.72 0 1.61 1.31 2.92 2.92 2.92S21 17.69 21 16.08s-1.31-2.92-2.92-2.92z"/></svg>
              </div>
              <a class="badge buy-btn" title="خرید از دیجی‌کالا" target="_blank" rel="noopener">
                <!-- خرید -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 4h-2l-1 2h2l2.68 9H19l2-8H8l-.62-2zM7 20a2 2 0 110-4 2 2 0 010 4zm10 0a2 2 0 110-4 2 2 0 010 4z"/></svg>
              </a>
            </div>
            <div class="size-lbl">88MB</div>
          </div>

          <!-- عنوان + شمار دانلود -->
          <div class="title tclick">پرسش‌های چهارگزینه‌ای (به همراه درسنامه) – خیلی سبز <span class="dlcount"></span></div>

          <!-- ستون راست: عدد امتیاز -->
          <div class="meta score-text" style="min-width:40px;text-align:center">؟</div>
        </div>
      </li>

      <li>
        <div class="book-card"
             data-id="geo11-shab"
             data-title="شب امتحان – خیلی سبز"
             data-download="https://mega.nz/file/R2YkAK7L#s2sUeQnr4IZ4IEx2vr9vFQMNZmSAcdDw4ggAtAatlqw"
             data-size="23"
             data-buy="https://www.digikala.com/product/dkp-820916/کتاب-شب-امتحان-جغرافیا-پایه-یازدهم-اثر-سیده-مریم-طاهری/"
             data-score="4.4" data-scoretext="۴.۴ امتیاز از ۲۶ رأی ثبت‌شده در دیجی‌کالا">
          <div class="leftcol">
            <div class="row-actions">
              <a class="badge dl-btn" title="دانلود" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
              </a>
              <div class="badge star-btn" title="امتیاز دیجی‌کالا">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
              </div>
            </div>
            <div class="row-actions">
              <div class="badge share-btn" title="اشتراک‌گذاری">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-0.76 0-1.44 0.3-1.96 0.77l-7.13-4.11c0.05-0.25 0.09-0.5 0.09-0.76s-0.04-0.51-0.09-0.76l7.09-4.1c0.54 0.5 1.25 0.81 2.04 0.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 0.26 0.04 0.51 0.09 0.76l-7.09 4.1c-0.54-0.5-1.25-0.81-2.04-0.81-1.66 0-3 1.34-3 3s1.34 3 3 3c0.79 0 1.5-0.31 2.04-0.81l7.13 4.11c-0.05 0.23-0.08 0.47-0.08 0.72 0 1.61 1.31 2.92 2.92 2.92S21 17.69 21 16.08s-1.31-2.92-2.92-2.92z"/></svg>
              </div>
              <a class="badge buy-btn" title="خرید از دیجی‌کالا" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 4h-2l-1 2h2l2.68 9H19l2-8H8l-.62-2zM7 20a2 2 0 110-4 2 2 0 010 4zm10 0a2 2 0 110-4 2 2 0 010 4z"/></svg>
              </a>
            </div>
            <div class="size-lbl">23MB</div>
          </div>

          <div class="title tclick">شب امتحان – خیلی سبز <span class="dlcount"></span></div>

          <div class="meta score-text" style="min-width:40px;text-align:center">4.4</div>
        </div>
      </li>
    </ul>
  </section>

  <!-- دهم -->
  <section class="panel">
    <h2>کتاب‌های جغرافیا، پایه دهم</h2>
    <ul class="books" id="list10">
      <li>
        <div class="book-card"
             data-id="geo10-shab"
             data-title="شب امتحان – خیلی سبز"
             data-download="https://s32.picofile.com/file/8481978634/%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7_%D8%AF%D9%87%D9%85%D8%8C_%D8%B4%D8%A8_%D8%A7%D9%85%D8%AA%D8%AD%D8%A7%D9%86_B_U_L.pdf.html"
             data-size="24"
             data-buy="https://www.digikala.com/product/dkp-4123378/کتاب-شب-امتحان-جغرافیا-ایران-دهم-اثر-مهدی-کاردان-و-شادی-کاریان-انتشارات-خیلی-سبز/"
             data-score="4.5" data-scoretext="۴.۵ امتیاز از ۶۷ رأی ثبت‌شده در دیجی‌کالا">
          <div class="leftcol">
            <div class="row-actions">
              <a class="badge dl-btn" title="دانلود" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
              </a>
              <div class="badge star-btn" title="امتیاز دیجی‌کالا">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
              </div>
            </div>
            <div class="row-actions">
              <div class="badge share-btn" title="اشتراک‌گذاری">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-0.76 0-1.44 0.3-1.96 0.77l-7.13-4.11c0.05-0.25 0.09-0.5 0.09-0.76s-0.04-0.51-0.09-0.76l7.09-4.1c0.54 0.5 1.25 0.81 2.04 0.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 0.26 0.04 0.51 0.09 0.76l-7.09 4.1c-0.54-0.5-1.25-0.81-2.04-0.81-1.66 0-3 1.34-3 3s1.34 3 3 3c0.79 0 1.5-0.31 2.04-0.81l7.13 4.11c-0.05 0.23-0.08 0.47-0.08 0.72 0 1.61 1.31 2.92 2.92 2.92S21 17.69 21 16.08s-1.31-2.92-2.92-2.92z"/></svg>
              </div>
              <a class="badge buy-btn" title="خرید از دیجی‌کالا" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 4h-2l-1 2h2l2.68 9H19l2-8H8l-.62-2zM7 20a2 2 0 110-4 2 2 0 010 4zm10 0a2 2 0 110-4 2 2 0 010 4z"/></svg>
              </a>
            </div>
            <div class="size-lbl">24MB</div>
          </div>

          <div class="title tclick">شب امتحان – خیلی سبز <span class="dlcount"></span></div>
          <div class="meta score-text" style="min-width:40px;text-align:center">4.5</div>
        </div>
      </li>

      <li>
        <div class="book-card"
             data-id="geo10-dars"
             data-title="درسنامه جغرافیا – خیلی سبز"
             data-download="https://s32.picofile.com/file/8481961634/%D8%AF%D8%B1%D8%B3%D9%86%D8%A7%D9%85%D9%87_%D8%AC%D8%BA%D8%B1%D8%A7%D9%81%DB%8C%D8%A7_%D8%AF%D9%87%D9%85_%D8%A8%D8%B1_%D8%B9%D9%85%D8%B1_%D9%84%D8%B9%D9%86%D8%AA.pdf.html"
             data-size="36"
             data-buy="https://www.digikala.com/product/dkp-1874006/کتاب-پرسش-های-چهار-گزینه-ای-جغرافیا-جامع-دهم-و-یازدهم-و-دوازدهم-رشته-انسانی-اثر-زهرا-نعمتی-و-الهه-همایون-زاده-انتشارات-خیلی-سبز/"
             data-score="4.2" data-scoretext="۴.۲ امتیاز از ۴۵ رأی ثبت‌شده در دیجی‌کالا">
          <div class="leftcol">
            <div class="row-actions">
              <a class="badge dl-btn" title="دانلود" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 2H4v2h16v-2z"/></svg>
              </a>
              <div class="badge star-btn" title="امتیاز دیجی‌کالا">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L24 9.753l-6 5.847 1.416 8.263L12 19.771 4.584 23.863 6 15.6 0 9.753l8.332-1.735z"/></svg>
              </div>
            </div>
            <div class="row-actions">
              <div class="badge share-btn" title="اشتراک‌گذاری">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-0.76 0-1.44 0.3-1.96 0.77l-7.13-4.11c0.05-0.25 0.09-0.5 0.09-0.76s-0.04-0.51-0.09-0.76l7.09-4.1c0.54 0.5 1.25 0.81 2.04 0.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 0.26 0.04 0.51 0.09 0.76l-7.09 4.1c-0.54-0.5-1.25-0.81-2.04-0.81-1.66 0-3 1.34-3 3s1.34 3 3 3c0.79 0 1.5-0.31 2.04-0.81l7.13 4.11c-0.05 0.23-0.08 0.47-0.08 0.72 0 1.61 1.31 2.92 2.92 2.92S21 17.69 21 16.08s-1.31-2.92-2.92-2.92z"/></svg>
              </div>
              <a class="badge buy-btn" title="خرید از دیجی‌کالا" target="_blank" rel="noopener">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 4h-2l-1 2h2l2.68 9H19l2-8H8l-.62-2zM7 20a2 2 0 110-4 2 2 0 010 4zM17 20a2 2 0 110-4 2 2 0 010 4z"/></svg>
              </a>
            </div>
            <div class="size-lbl">36MB</div>
          </div>

          <div class="title tclick">درسنامه جغرافیا – خیلی سبز <span class="dlcount"></span></div>
          <div class="meta score-text" style="min-width:40px;text-align:center">4.2</div>
        </div>
      </li>
    </ul>
  </section>

  <div style="text-align:center">
    <a class="btn-back" href="index.html">بازگشت به منوی اصلی</a>
  </div>

  <div id="counter"><span id="visit-count">بازدید این صفحه</span></div>

  <!-- مودال پیش‌نمایش (بدون تغییر نسبت به قبل) -->
  <div class="modal" id="previewModal">
    <div class="box">
      <h3 id="prevTitle">پیش‌نمایش</h3>
      <iframe id="prevFrame" src=""></iframe>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn gray" id="closePrev">بستن</button>
      </div>
    </div>
  </div>

  <!-- توست -->
  <div class="toast" id="toast"></div>

<script>
  // ------ شمارنده بازدید صفحه (همان قبلی)
  async function loadVisits(){
    const slug='geography';
    try{
      const r=await fetch(`/api/visits?slug=${encodeURIComponent(slug)}`,{cache:'no-store'});
      const d=await r.json();
      if(!r.ok||typeof d.value!=='number')throw 0;
      document.getElementById('visit-count').textContent=`بازدید این صفحه: ${d.value}`;
      await fetch(`/api/log?slug=${encodeURIComponent(slug)}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ua:navigator.userAgent})
      });
    }catch{
      document.getElementById('visit-count').textContent='خطا در دریافت شمارنده';
    }
  }
  loadVisits();

  // ------ Toast
  let toastTimer=null;
  function showToast(txt){
    const t=document.getElementById('toast');
    t.textContent=txt;
    t.classList.remove('hide');
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>{
      t.classList.remove('show');
      t.classList.add('hide');
    },6000); // 6 ثانیه
  }

  // ------ LocalStorage helpers
  function lsGet(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
  function lsSet(k,v){localStorage.setItem(k,JSON.stringify(v))}

  // ------ مودال پیش‌نمایش (به درخواست تو تغییری نکرده)
  const prevModal=document.getElementById('previewModal');
  const prevTitle=document.getElementById('prevTitle');
  const prevFrame=document.getElementById('prevFrame');
  document.getElementById('closePrev').onclick=()=>{prevModal.style.display='none'; prevFrame.src=''};
  prevModal.addEventListener('click',(e)=>{ if(e.target===prevModal){prevModal.style.display='none'; prevFrame.src=''} });

  // ------ کنترل مرتب‌سازی با پنل شیشه‌ای
  const sortOverlay=document.getElementById('sortOverlay');
  const sortOpener=document.getElementById('sortOpener');
  let sortMode='default';
  sortOpener.addEventListener('click',()=>{ sortOverlay.style.display='flex' });
  sortOverlay.addEventListener('click',(e)=>{ if(e.target===sortOverlay) sortOverlay.style.display='none' });
  sortOverlay.querySelectorAll('.opt').forEach(opt=>{
    opt.addEventListener('click',()=>{
      sortMode=opt.dataset.mode;
      const label={
        'default':'پیش‌فرض',
        'score':'بیشترین امتیاز',
        'downloads':'بیشترین دانلود',
        'size':'کم‌حجم‌ترین'
      }[sortMode]||'پیش‌فرض';
      sortOpener.textContent='مرتب‌سازی: '+label;
      sortOverlay.style.display='none';
      filterAndSort();
    });
  });

  // ------ سرچ با دکمه ×
  const searchBox=document.getElementById('searchBox');
  const clearX=document.getElementById('clearX');
  const searchBoxWrap=document.getElementById('searchBoxWrap');
  searchBox.addEventListener('input',()=>{
    searchBoxWrap.classList.toggle('has-val', searchBox.value.trim().length>0);
    filterAndSort();
  });
  clearX.addEventListener('click',()=>{
    searchBox.value='';
    searchBox.dispatchEvent(new Event('input'));
  });

  // ------ دانلود شمارنده فقط با کلیک
  async function incGlobalDl(bookId){
    try{
      await fetch(`/api/log?slug=${encodeURIComponent('dl_'+bookId)}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ua:navigator.userAgent})
      });
    }catch{}
  }
  // اگر مطمئن شدی GET /api/visits افزایش نمی‌دهد، این را از حالت کامنت خارج کن
  async function getGlobalDl(bookId){
    try{
      const r=await fetch(`/api/visits?slug=${encodeURIComponent('dl_'+bookId)}`,{cache:'no-store'});
      const d=await r.json();
      if(!r.ok||typeof d.value!=='number')throw 0;
      return d.value;
    }catch{return null}
  }

  // ------ کارت‌ها
  const cards=document.querySelectorAll('.book-card');
  cards.forEach(card=>{
    const id=card.dataset.id,
          title=card.dataset.title,
          dlsrc=card.dataset.download,
          size=card.dataset.size,
          buy=card.dataset.buy,
          score=card.dataset.score,
          scoreText=card.dataset.scoretext;

    const dlBtn=card.querySelector('.dl-btn');
    const shareBtn=card.querySelector('.share-btn');
    const buyBtn=card.querySelector('.buy-btn');
    const starBtn=card.querySelector('.star-btn');
    const scoreEl=card.querySelector('.score-text');
    const dlCountEl=card.querySelector('.dlcount');

    // set attributes
    dlBtn.href=dlsrc;
    buyBtn.href=buy;
    scoreEl.textContent=score;
    card.querySelector('.size-lbl').textContent=size+'MB';

    // نمایش شمار دانلود (همیشه حتی اگر صفر باشد)
    async function refreshCount(){
      const local=lsGet('dl_'+id,0);
      // اگر مطمئن شدی GET /api/visits شمار را زیاد نمی‌کند می‌توانی فعال کنی:
      // const remote=await getGlobalDl(id);
      // const total=(remote??0)+local;
      const total = local; // فعلاً فقط local تا مشکل افزایش با بازدید حل شود
      card.dataset.dl = total;
      dlCountEl.textContent = `(${total} دانلود)`;
    }
    refreshCount();

    dlBtn.addEventListener('click',async (e)=>{
      // افزایش فقط با کلیک
      lsSet('dl_'+id, lsGet('dl_'+id,0)+1);
      dlBtn.style.transform='scale(1.15)';setTimeout(()=>dlBtn.style.transform='',150);
      refreshCount();
      await incGlobalDl(id); // فقط کلیک باعث لاگ سرور می‌شود
    });

    // اشتراک گذاری لینک دانلود
    shareBtn.addEventListener('click',async ()=>{
      const shareData={title, text:title+' - دانلود', url:dlsrc};
      try{
        if(navigator.share){ await navigator.share(shareData); }
        else{ await navigator.clipboard.writeText(dlsrc); showToast('لینک دانلود در کلیپ‌بورد کپی شد'); }
      }catch{}
    });

    // نمایش پیام امتیاز
    starBtn.addEventListener('click',()=>{
      showToast(scoreText);
      starBtn.style.transform='scale(1.12)'; setTimeout(()=>starBtn.style.transform='',150);
    });

    // پیش‌نمایش: عنوان
    card.querySelector('.tclick').addEventListener('click',()=>{
      prevTitle.textContent='پیش‌نمایش «'+title+'»';
      prevFrame.src='https://docs.google.com/gview?embedded=1&url='+encodeURIComponent(dlsrc);
      prevModal.style.display='flex';
    });
  });

  function filterAndSort(){
    const q=searchBox.value.trim();
    document.querySelectorAll('.books').forEach(ul=>{
      const items=Array.from(ul.querySelectorAll('li'));
      // فیلتر
      items.forEach(li=>{
        const card=li.querySelector('.book-card');
        const t=card.dataset.title;
        li.style.display = (!q || t.includes(q)) ? '' : 'none';
      });
      // مرتب‌سازی
      const visible=items.filter(li=>li.style.display!=='none');
      visible.sort((a,b)=>{
        const ca=a.querySelector('.book-card'), cb=b.querySelector('.book-card');
        if(sortMode==='size'){
          return parseFloat(ca.dataset.size)-parseFloat(cb.dataset.size); // کم‌حجم‌ترین
        }else if(sortMode==='score'){
          const sA=parseFloat(ca.dataset.score)||0, sB=parseFloat(cb.dataset.score)||0;
          return sB-sA;
        }else if(sortMode==='downloads'){
          const dA=parseInt(ca.dataset.dl||'0'), dB=parseInt(cb.dataset.dl||'0');
          return dB-dA;
        }
        return 0;
      });
      visible.forEach(li=>ul.appendChild(li));
    });
  }
</script>
</body>
</html>
