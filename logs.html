<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š Ù„ÛŒØ³Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯Ù‡Ø§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @font-face {
      font-family: 'iranyekan';
      src: url('iranyekanweblight.woff') format('woff');
    }
    body {
      font-family: 'iranyekan', sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      color: #1da1f2;
      margin: 20px 0;
    }
    .stats {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px;
    }
    .card {
      background: #1c1c1c;
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      min-width: 150px;
    }
    .card h2 {
      margin: 0;
      font-size: 20px;
      color: #1da1f2;
    }
    .card p {
      margin: 5px 0 0;
      font-size: 16px;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background: #1da1f2;
      color: #fff;
      cursor: pointer;
    }
    tr:hover td {
      background: #222;
    }
    #controls {
      margin: 20px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #1da1f2;
      color: white;
      font-size: 14px;
    }
    button:hover {
      background: #0d8adb;
    }
    canvas {
      max-width: 600px;
      margin: 30px auto;
      display: block;
    }
  </style>
</head>
<body>

  <h1>ğŸ“‘ Ù„ÛŒØ³Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯Ù‡Ø§</h1>

  <!-- Ø¢Ù…Ø§Ø± -->
  <div class="stats">
    <div class="card"><h2 id="total">0</h2><p>Ú©Ù„ Ø¨Ø§Ø²Ø¯ÛŒØ¯Ù‡Ø§</p></div>
    <div class="card"><h2 id="today">0</h2><p>Ø¨Ø§Ø²Ø¯ÛŒØ¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</p></div>
    <div class="card"><h2 id="chrome">0</h2><p>Ù…Ø±ÙˆØ±Ú¯Ø± Chrome</p></div>
    <div class="card"><h2 id="mobile">0</h2><p>Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø§Ø² Ù…ÙˆØ¨Ø§ÛŒÙ„</p></div>
  </div>

  <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
  <div id="controls">
    <button onclick="exportCSV()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
    <button onclick="clearLogs()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§</button>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ -->
  <table id="logsTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">ØµÙØ­Ù‡</th>
        <th onclick="sortTable(1)">Ø²Ù…Ø§Ù†</th>
        <th onclick="sortTable(2)">User-Agent</th>
        <th>Ø¯Ø³ØªÚ¯Ø§Ù‡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
  <canvas id="chartBrowsers"></canvas>
  <canvas id="chartPages"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ğŸ” Password Protection
    const pass = prompt("Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    if (pass !== "1975") {
      document.body.innerHTML = "<h2 style='margin-top:50px;color:red'>â›” Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²</h2>";
      throw new Error("Unauthorized");
    }

    async function loadLogs() {
      const res = await fetch('/api/logs?slug=index', { cache: 'no-store' });
      const data = await res.json();
      const logs = data.logs || [];
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";

      let total = logs.length;
      let today = 0;
      let chrome = 0;
      let mobile = 0;

      const browserCounts = {};
      const pageCounts = {};

      logs.forEach(log => {
        const date = new Date(log.time);
        const todayStr = new Date().toISOString().slice(0,10);
        if (log.time.startsWith(todayStr)) today++;

        const ua = log.ua || "-";
        if (/chrome/i.test(ua)) chrome++;
        if (/mobile/i.test(ua)) mobile++;

        // Ø¯Ø³ØªÚ¯Ø§Ù‡
        let device = /mobile/i.test(ua) ? "ğŸ“± Ù…ÙˆØ¨Ø§ÛŒÙ„" : "ğŸ’» Ø¯Ø³Ú©ØªØ§Ù¾";

        // Ø´Ù…Ø§Ø±Ø´ Ù…Ø±ÙˆØ±Ú¯Ø±
        const br = /firefox/i.test(ua) ? "Firefox" :
                   /safari/i.test(ua) && !/chrome/i.test(ua) ? "Safari" :
                   /edg/i.test(ua) ? "Edge" : "Chrome";
        browserCounts[br] = (browserCounts[br]||0)+1;

        // Ø´Ù…Ø§Ø±Ø´ ØµÙØ­Ù‡
        const pg = log.page || "Ù†Ø§Ù…Ø´Ø®Øµ";
        pageCounts[pg] = (pageCounts[pg]||0)+1;

        tbody.innerHTML += `
          <tr>
            <td>${pg}</td>
            <td>${new Date(log.time).toLocaleString("fa-IR")}</td>
            <td>${ua}</td>
            <td>${device}</td>
          </tr>
        `;
      });

      document.getElementById("total").textContent = total;
      document.getElementById("today").textContent = today;
      document.getElementById("chrome").textContent = chrome;
      document.getElementById("mobile").textContent = mobile;

      drawChart("chartBrowsers", "Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§", browserCounts);
      drawChart("chartPages", "ØµÙØ­Ø§Øª", pageCounts);
    }

    function drawChart(id, label, dataObj) {
      const ctx = document.getElementById(id);
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(dataObj),
          datasets: [{
            label,
            data: Object.values(dataObj)
          }]
        }
      });
    }

    function sortTable(n) {
      const table = document.getElementById("logsTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < (rows.length - 1); i++) {
          let shouldSwitch = false;
          const x = rows[i].getElementsByTagName("TD")[n];
          const y = rows[i + 1].getElementsByTagName("TD")[n];
          if (dir === "asc" && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) shouldSwitch = true;
          if (dir === "desc" && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) shouldSwitch = true;
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true; switchcount++;
            break;
          }
        }
        if (!switching && dir === "asc" && switchcount === 0) { dir = "desc"; switching = true; }
      }
    }

    function exportCSV() {
      const rows = [...document.querySelectorAll("table tr")].map(tr => 
        [...tr.children].map(td => td.innerText).join(",")
      ).join("\n");
      const blob = new Blob([rows], { type: 'text/csv' });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "logs.csv";
      a.click();
    }

    async function clearLogs() {
      if (!confirm("Ù‡Ù…Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ")) return;
      await fetch("/api/clearLogs", { method: "POST" });
      loadLogs();
    }

    loadLogs();
  </script>
</body>
</html>
