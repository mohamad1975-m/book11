<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مدیریت بازدیدها</title>
  <style>
    @font-face {
      font-family: 'iranyekan';
      src: url('iranyekanweblight.woff') format('woff');
    }
    body {
      font-family: 'iranyekan', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f1f1f1; margin:0; padding:18px;
    }
    header {
      background: #1C93E3; color: #fff;
      padding: 12px; border-radius: 12px;
      text-align: center; font-size: 20px; font-weight: bold;
      box-shadow: 0 3px 8px rgba(0,0,0,.35);
    }
    .card {
      background: #1e1e2f; border-radius: 12px; padding: 16px; margin-top: 16px;
      box-shadow: 0 3px 10px rgba(0,0,0,.5);
    }
    .card h3 { margin:0 0 8px 0; color:#1C93E3; }
    .stats p { margin: 6px 0; }
    table {
      width:100%; border-collapse: collapse; margin-top: 16px;
      background:#252540; border-radius:12px; overflow:hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,.4);
    }
    th, td {
      padding: 10px; border: 1px solid #333; text-align:center; font-size:14px;
    }
    th { background:#303060; color:#1C93E3; }
    tr:nth-child(even) { background:#2e2e4d; }
    tr:hover { background:#3b3b59; }
    .ua { direction:ltr; text-align:left; font-family: monospace; font-size: 12px; }
  </style>
</head>
<body>
<header>📊 مدیریت بازدیدها</header>

<div class="card stats" id="stats">در حال بارگذاری آمار...</div>

<table id="logs-table">
  <thead>
    <tr>
      <th>#</th>
      <th>صفحه</th>
      <th>زمان</th>
      <th>مرورگر</th>
      <th>سیستم‌عامل</th>
      <th>دستگاه</th>
      <th>User-Agent کامل</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  function formatDate(iso) {
    const d = new Date(iso);
    return d.toLocaleString("fa-IR", { hour12:false });
  }

  // --- helperها ----
  function detectBrowserFromUA(ua='') {
    ua = ua.toLowerCase();
    if (ua.includes('edg')) return 'Microsoft Edge';
    if (ua.includes('chrome')) return 'Google Chrome';
    if (ua.includes('firefox')) return 'Mozilla Firefox';
    if (ua.includes('safari') && !ua.includes('chrome')) return 'Safari';
    if (ua.includes('opr') || ua.includes('opera')) return 'Opera';
    return 'نامشخص';
  }
  function detectOSFromUA(ua='') {
    const s = ua.toLowerCase();
    if (s.includes('android')) {
      const m = s.match(/android\s+([\d\.]+)/);
      return m ? `Android ${m[1]}` : 'Android';
    }
    if (s.includes('iphone') || s.includes('ipad')) return 'iOS';
    if (s.includes('mac os x')) return 'macOS';
    if (s.includes('windows nt')) {
      const m = s.match(/windows nt ([0-9\.]+)/);
      return m ? `Windows (NT ${m[1]})` : 'Windows';
    }
    if (s.includes('linux')) return 'Linux';
    return 'نامشخص';
  }
  function detectDeviceFromUA(ua='') {
    const s = ua.toLowerCase();
    if (s.includes('android')) return '📱 Android Device';
    if (s.includes('iphone') || s.includes('ipad')) return '📱 iOS Device';
    if (s.includes('windows') || s.includes('macintosh') || s.includes('linux')) return '💻 Desktop/Laptop';
    return 'نامشخص';
  }

  // --- تشخیص با UA-CH (دقیق‌تر) ---
  function resolveOSWithUAch(ch, fallbackUA) {
    if (ch && ch.platform) {
      const p = ch.platform.toLowerCase();
      if (p === 'windows') {
        // platformVersion در Win11 معمولاً >= 13 است، در Win10 حدود 10
        const major = parseInt((ch.platformVersion||'').split('.')[0] || '0', 10);
        const winName = (major >= 13) ? 'Windows 11' : 'Windows 10';
        return ch.platformVersion ? `${winName} (v${ch.platformVersion})` : winName;
      }
      if (p === 'android') {
        return ch.platformVersion ? `Android ${ch.platformVersion}` : 'Android';
      }
      if (p === 'ios') return 'iOS';
      if (p === 'macos' || p === 'mac os' || p === 'mac os x') return 'macOS';
      if (p === 'linux') return 'Linux';
      return ch.platform;
    }
    return detectOSFromUA(fallbackUA);
  }
  function resolveBrowserWithUAch(ch, fallbackUA) {
    if (ch && ch.brands) {
      // اولین برند غیرِ "Not" را انتخاب می‌کنیم
      const parts = ch.brands.split(',').map(s => s.trim());
      if (parts.length) return parts[0];
    }
    return detectBrowserFromUA(fallbackUA);
  }
  function resolveDeviceWithUAch(ch, fallbackUA) {
    if (ch && typeof ch.mobile === 'boolean') {
      return ch.mobile ? '📱 Mobile' : '💻 Desktop/Laptop';
    }
    return detectDeviceFromUA(fallbackUA);
  }

  async function loadLogs() {
    const res = await fetch('/api/logs', { cache: 'no-store' });
    const data = await res.json();
    const tbody = document.querySelector('#logs-table tbody');
    tbody.innerHTML = '';

    if (!res.ok || !Array.isArray(data.logs)) {
      document.getElementById('stats').textContent = '❌ خطا در دریافت لاگ‌ها';
      return;
    }
    const logs = data.logs;

    logs.forEach((log, i) => {
      const ua = log.ua || '';
      const ch = log.uaCH || null;

      const os   = resolveOSWithUAch(ch, ua);
      const bro  = resolveBrowserWithUAch(ch, ua);
      const dev  = resolveDeviceWithUAch(ch, ua);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${log.slug || '-'}</td>
        <td>${formatDate(log.time)}</td>
        <td>${bro}</td>
        <td>${os}</td>
        <td>${dev}</td>
        <td class="ua">${ua}</td>
      `;
      tbody.appendChild(tr);
    });

    // آمار کلی
    const sum = logs.length;
    const byPage = {};
    logs.forEach(l => {
      byPage[l.slug || '-'] = (byPage[l.slug || '-'] || 0) + 1;
    });

    let html = `<h3>📈 آمار کلی</h3><p>🔹 تعداد کل بازدیدها: <b>${sum}</b></p>`;
    for (const k in byPage) {
      html += `<p>📄 صفحه <b>${k}</b> → ${byPage[k]} بازدید</p>`;
    }
    document.getElementById('stats').innerHTML = html;
  }

  loadLogs();
  setInterval(loadLogs, 5000);
</script>
</body>
</html>
