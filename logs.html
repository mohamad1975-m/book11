<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مدیریت بازدیدها 📊</title>
  <style>
    body {background:#0f2027; background:linear-gradient(to right,#2c5364,#203a43,#0f2027);
      font-family:sans-serif; color:#fff; margin:0; padding:0;}
    header {background:#1C93E3; padding:15px; text-align:center; font-size:20px; font-weight:bold; border-radius:0 0 10px 10px}
    table {width:95%; margin:20px auto; border-collapse:collapse; background:#1e1e2f; border-radius:8px; overflow:hidden}
    th,td {padding:10px; border-bottom:1px solid #333; text-align:center; font-size:14px}
    th {background:#2e2e4f}
    tr:hover {background:#2a2a40}
    .stats {max-width:95%; margin:20px auto; background:#1e1e2f; padding:10px 15px; border-radius:8px; font-size:15px; line-height:1.7}
  </style>
</head>
<body>
  <header>📊 مدیریت بازدیدها</header>

  <div class="stats" id="stats">در حال بارگذاری...</div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>صفحه</th>
        <th>زمان</th>
        <th>مرورگر</th>
        <th>سیستم‌عامل</th>
        <th>دستگاه</th>
        <th>User-Agent کامل</th>
      </tr>
    </thead>
    <tbody id="logs-body"></tbody>
  </table>

<script>
function detectBrowserFromUA(ua) {
  ua = ua || "";
  if (ua.includes("Edg/")) return "Microsoft Edge";
  if (ua.includes("OPR/") || ua.includes("Opera")) return "Opera";
  if (ua.includes("Chrome/")) return "Google Chrome";
  if (ua.includes("Safari/") && !ua.includes("Chrome/")) return "Safari";
  if (ua.includes("Firefox/")) return "Mozilla Firefox";
  if (ua.includes("MSIE") || ua.includes("Trident/")) return "Internet Explorer";
  return "ناشناخته";
}

function detectDeviceFromUAch(ch, ua) {
  if (ch && typeof ch.mobile !== "undefined") {
    return ch.mobile ? "Mobile 📱" : "Desktop/Laptop 💻";
  }
  if (/Mobi|Android/i.test(ua)) return "Mobile 📱";
  return "Desktop/Laptop 💻";
}

function detectOSFromUA(ua) {
  if (/Windows NT 10.0/.test(ua)) return "Windows 10";
  if (/Windows NT 11.0/.test(ua)) return "Windows 11";
  if (/Windows NT 6.3/.test(ua)) return "Windows 8.1";
  if (/Windows NT 6.2/.test(ua)) return "Windows 8";
  if (/Windows NT 6.1/.test(ua)) return "Windows 7";
  if (/Android/.test(ua)) return "Android";
  if (/iPhone|iPad|iPod/.test(ua)) return "iOS";
  if (/Mac OS X/.test(ua)) return "macOS";
  if (/Linux/.test(ua)) return "Linux";
  return "نامشخص";
}

function resolveOSWithUAch(ch, fallbackUA) {
  if (ch && ch.platform) {
    const p = ch.platform.toLowerCase();
    let name = ch.platform;
    if (p === 'windows') {
      const major = parseInt((ch.platformVersion||'').split('.')[0] || '0', 10);
      const winName = (major >= 13) ? 'Windows 11' : 'Windows 10';
      name = ch.platformVersion ? `${winName} (v${ch.platformVersion})` : winName;
    } else if (p === 'android') {
      name = ch.platformVersion ? `Android ${ch.platformVersion}` : 'Android';
    } else if (p === 'ios') {
      name = 'iOS';
    } else if (p.includes('mac')) {
      name = 'macOS';
    } else if (p === 'linux') {
      name = 'Linux';
    }
    return { text: `${name} 🟢`, source: 'uaCH' };
  }
  return { text: `${detectOSFromUA(fallbackUA)} 🟡`, source: 'ua' };
}

async function loadLogs() {
  try {
    const res = await fetch("/api/logs", { cache: "no-store" });
    const logs = await res.json();
    if (!Array.isArray(logs)) throw new Error("bad response");

    const tbody = document.getElementById("logs-body");
    tbody.innerHTML = "";

    logs.forEach((log, i) => {
      const ua = log.ua || "";
      const ch = log.uaCH || null;
      const browser = detectBrowserFromUA(ua);
      const device = detectDeviceFromUAch(ch, ua);
      const osObj = resolveOSWithUAch(ch, ua);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${log.slug || "-"}</td>
        <td>${new Date(log.time).toLocaleString("fa-IR")}</td>
        <td>${browser}</td>
        <td>${osObj.text}</td>
        <td>${device}</td>
        <td>${ua}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("stats").textContent = `آمار کلی 🔹 تعداد کل بازدیدها: ${logs.length}`;
  } catch (e) {
    document.getElementById("stats").textContent = "خطا در دریافت داده‌ها";
    console.error(e);
  }
}
loadLogs();
</script>
</body>
</html>
