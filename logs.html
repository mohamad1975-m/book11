<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لیست بازدیدها</title>

  <!-- فونت ایران‌یکان -->
  <style>
    @font-face {
      font-family: 'IranYekan';
      src: url('./iranyekanweblight.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --bg:#111;
      --panel:#1b1b1b;
      --panel2:#0e0e0e;
      --blue:#1C93E3;
      --text:#eee;
      --muted:#aaa;
      --row:#171717;
      --rowHover:#222;
      --border:#2b2b2b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:'IranYekan',sans-serif;
      padding:16px;
    }
    .card{
      background:var(--panel);
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      border:1px solid var(--border);
    }
    .card .header{
      background:var(--blue);
      color:#fff;
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .header h1{
      margin:0; font-size:22px; display:flex; align-items:center; gap:8px;
    }
    .header .tools{ display:flex; gap:8px; align-items:center; }

    .btn{
      background:#0d6efd; border:none; color:#fff; border-radius:8px;
      padding:8px 10px; cursor:pointer; font-size:13px;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.secondary{ background:#2f2f2f; color:#fff; }
    .input, .select{
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px 10px;
    }

    .filters{
      display:flex; gap:8px; padding:10px; background:var(--panel2); border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:10px; text-align:center; border-bottom:1px solid var(--border); font-size:13.5px;
    }
    thead th{
      background:var(--panel2); font-weight:bold; color:#fff;
      position:sticky; top:0; z-index:1;
    }
    tbody tr{ background:var(--row); }
    tbody tr:hover{ background:var(--rowHover); }
    .muted{ color:var(--muted); font-size:12px; }
    .foot{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px; background:var(--panel2); border-top:1px solid var(--border);
      color:var(--muted); font-size:12.5px;
    }

    /* دیالوگ رمز */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:flex; align-items:center; justify-content:center;
      z-index:2000;
    }
    .dialog{
      background:#1b1b1b; border:1px solid var(--border);
      padding:20px; border-radius:12px; width:95%; max-width:380px;
      color:var(--text); display:flex; flex-direction:column; gap:10px;
      box-shadow:0 8px 30px rgba(0,0,0,.5)
    }
    .dialog h3{ margin:0 0 6px 0; font-size:17px; }
    .dialog .row{ display:flex; gap:8px }
  </style>
</head>
<body>

  <!-- دیالوگ رمز -->
  <div id="lock" class="overlay" hidden>
    <div class="dialog">
      <h3>ورود به صفحه مدیریت</h3>
      <div class="muted">برای مشاهده لاگ‌ها، رمز عبور را وارد کنید.</div>
      <div class="row">
        <input id="pwd" class="input" type="password" placeholder="رمز عبور (1975)"/>
        <button class="btn" onclick="checkPass()">ورود</button>
      </div>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <div class="header">
      <h1>لیست بازدیدها <span class="muted" id="count"></span></h1>
      <div class="tools">
        <button id="exportCsv" class="btn">خروجی CSV</button>
      </div>
    </div>

    <div class="filters">
      <input id="q" class="input" style="flex:1" placeholder="جستجو در User-Agent / سیستم‌عامل / مرورگر / صفحه"/>
      <select id="slugSel" class="select">
        <option value="">همه صفحات</option>
      </select>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>صفحه</th>
          <th>زمان</th>
          <th>سیستم‌عامل</th>
          <th>مرورگر</th>
          <th>User-Agent</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="foot">
      <div>مرتب‌سازی: جدیدترین بالا</div>
      <div id="status">در حال بارگذاری…</div>
    </div>
  </div>

  <script>
    // --- قفل با رمز 1975 (یک‌بار برای هر سشن) ---
    const PASS = "1975";
    const lockEl = document.getElementById('lock');
    function checkLock(){
      if(sessionStorage.getItem('ok-logs') === '1'){ lockEl.hidden = true; return; }
      lockEl.hidden = false;
    }
    function checkPass(){
      const p = document.getElementById('pwd').value.trim();
      const msg = document.getElementById('msg');
      if(p === PASS){
        sessionStorage.setItem('ok-logs','1');
        lockEl.hidden = true;
        loadAll();
      }else{
        msg.textContent = 'رمز اشتباه است.';
      }
    }
    // با Enter هم تایید شود
    document.getElementById('pwd').addEventListener('keydown', e=>{
      if(e.key === 'Enter') checkPass();
    });

    // --- ابزارها ---
    const $ = (s)=>document.querySelector(s);
    const tbody = $('#tbl tbody');
    const qInput = $('#q');
    const slugSel = $('#slugSel');
    const statusEl = $('#status');
    const countEl = $('#count');

    let LOGS = [];          // همه‌ی لاگ‌ها (آرایه اشیا)
    let VIEW = [];          // نمای فیلترشده و مرتب شده

    function formatTime(t){
      if(!t) return '-';
      let d;
      if(!isNaN(t)) d = new Date(parseInt(t,10));
      else d = new Date(t);
      if(isNaN(d.getTime())) return '-';
      // تاریخ و زمان شمسی
      return d.toLocaleString('fa-IR');
    }
    function parseOS(ua){
      if(!ua) return '-';
      const m = /Windows|Android|iPhone|iPad|Mac OS X|Linux/i.exec(ua);
      return m ? m[0] : 'Other';
    }
    function parseBrowser(ua){
      if(!ua) return '-';
      const m = /Edg|Chrome|Safari|Firefox/i.exec(ua);
      return m ? (m[0]==='Edg'?'Edge':m[0]) : 'Other';
    }

    // تبدیل داده‌ی خام به شیء استاندارد
    function normalizeLog(x){
      let obj=x;
      try{
        if(Array.isArray(x)) obj = JSON.parse(x[0]);
        else if(typeof x==='string') obj = JSON.parse(x);
      }catch(_){ /* ignore */ }
      // سازگاری با نسخه‌های قبلی
      if(obj && obj.parsed){
        const parts = String(obj.parsed).split(' - ');
        obj.os = parts[0] || parseOS(obj.ua);
        obj.browser = parts[1] || parseBrowser(obj.ua);
      }else{
        obj.os = parseOS(obj.ua);
        obj.browser = parseBrowser(obj.ua);
      }
      obj.slug = obj.slug || 'index';
      return obj;
    }

    async function fetchLogs(slug=''){
      // اگر slug خالی باشد، همان index را می‌گیریم (سمت‌سرور فعلاً همان را پوشش می‌دهد)
      const url = slug ? `/api/logs?slug=${encodeURIComponent(slug)}` : '/api/logs?slug=index';
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok){
        const t=await r.text(); throw new Error(t||r.status);
      }
      const data = await r.json();
      const raw = Array.isArray(data.logs)? data.logs : [];
      const arr = raw.map(normalizeLog);

      // مرتب‌سازی: جدیدترین بالا
      arr.sort((a,b)=>{
        const ta = isNaN(a.time)? (new Date(a.time)).getTime() : parseInt(a.time,10);
        const tb = isNaN(b.time)? (new Date(b.time)).getTime() : parseInt(b.time,10);
        return (tb||0)-(ta||0);
      });
      return arr;
    }

    function buildSlugOptions(){
      const set = new Set(LOGS.map(x=>x.slug||'index'));
      const old = slugSel.value;
      slugSel.innerHTML = `<option value="">همه صفحات</option>` +
        [...set].map(s=>`<option ${s===old?'selected':''} value="${s}">${s}</option>`).join('');
    }

    function renderTable(){
      const q = qInput.value.trim().toLowerCase();
      const sel = slugSel.value.trim();

      VIEW = LOGS.filter(l=>{
        if(sel && String(l.slug) !== sel) return false;
        if(!q) return true;
        const hay = [
          l.ua||'',
          l.os||'',
          l.browser||'',
          l.slug||''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      tbody.innerHTML = VIEW.map(l=>`
        <tr>
          <td>${l.slug || '-'}</td>
          <td>${formatTime(l.time)}</td>
          <td>${l.os || '-'}</td>
          <td>${l.browser || '-'}</td>
          <td class="muted" style="text-align:right">${l.ua || '-'}</td>
        </tr>
      `).join('');

      countEl.textContent = `(${VIEW.length.toLocaleString('fa-IR')} رکورد)`;
      statusEl.textContent = 'آماده';
    }

    function exportCSV(){
      if(!VIEW.length){ alert('چیزی برای خروجی نیست.'); return; }
      const rows = [
        ['slug','time','os','browser','userAgent'],
        ...VIEW.map(l=>[
          l.slug || '',
          formatTime(l.time),
          l.os || '',
          l.browser || '',
          l.ua || ''
        ])
      ];
      const csv = rows.map(r=>r.map(x=>{
        const s = String(x).replace(/"/g,'""');
        return `"${s}"`;
      }).join(',')).join('\n');

      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `logs_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function loadAll(){
      try{
        statusEl.textContent='در حال دریافت...';
        LOGS = await fetchLogs('index');   // فعلاً از index می‌خوانیم
        buildSlugOptions();
        renderTable();
      }catch(e){
        statusEl.textContent='خطا در دریافت';
        console.error(e);
      }
    }

    // رویدادها
    qInput.addEventListener('input', renderTable);
    slugSel.addEventListener('change', async ()=>{
      // وقتی slug عوض شد، از سرور همان را بگیریم
      try{
        statusEl.textContent='در حال دریافت...';
        LOGS = await fetchLogs(slugSel.value);
        renderTable();
      }catch(e){
        statusEl.textContent='خطا در دریافت';
        console.error(e);
      }
    });
    document.getElementById('exportCsv').addEventListener('click', exportCSV);

    // شروع
    checkLock();
    if(sessionStorage.getItem('ok-logs')==='1'){
      loadAll();
    }
  </script>
</body>
</html>
